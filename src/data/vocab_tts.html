<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC Vocabulary TTS Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6fb; margin: 0; }
        .container { max-width: 900px; margin: 30px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 32px; }
        h1 { text-align: center; color: #667eea; margin-bottom: 10px; }
        .controls { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; justify-content: center; }
        .word-list { margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px; border-bottom: 1px solid #e9ecef; text-align: left; }
        th { background: #f8f9fa; }
        tr:last-child td { border-bottom: none; }
        .btn { background: linear-gradient(45deg, #667eea, #764ba2); color: white; border: none; padding: 7px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: 0.2s; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .audio-player { width: 120px; vertical-align: middle; }
        .status { font-size: 0.95em; color: #28a745; margin-left: 8px; }
        .error { color: #dc3545; }
        @media (max-width: 600px) { .container { padding: 10px; } th, td { font-size: 13px; } }
    </style>
</head>
<body>
<div class="container">
    <h1><i class="fas fa-volume-up"></i> TOEIC Vocabulary TTS Generator</h1>
    <div class="controls">
        <label>Giọng đọc:
            <select id="voiceSelect">
                <option value="en-US-Standard-B">Nam (B)</option>
                <option value="en-US-Standard-D">Nam (D)</option>
                <option value="en-US-Standard-C">Nữ (C)</option>
                <option value="en-US-Standard-E">Nữ (E)</option>
            </select>
        </label>
        <button class="btn" onclick="generateAllAudio()"><i class="fas fa-play"></i> Tạo audio tất cả</button>
    </div>
    <div class="word-list">
        <table id="vocabTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Từ vựng</th>
                    <th>Loại</th>
                    <th>Phiên âm</th>
                    <th>Ý nghĩa</th>
                    <th>Audio</th>
                    <th>Tải</th>
                </tr>
            </thead>
            <tbody id="vocabBody">
                <!-- Data will be inserted here -->
            </tbody>
        </table>
    </div>
</div>
<script>
// Nếu chạy local, bạn có thể copy nội dung data_question.js vào biến vocabData dưới đây:
// XÓA biến vocabData cứng
// const vocabData = [
//   { "word": "accommodations", "type": "n", "phonetic": "/əˌkɑːməˈdeɪʃənz/", "meaning": "chỗ ở" },
//   { "word": "allergic", "type": "adj", "phonetic": "/əˈlɜːrdʒɪk/", "meaning": "gây dị ứng" },
//   { "word": "close", "type": "adj/v", "phonetic": "/kloʊz/", "meaning": "gần; đóng" },
//   { "word": "comfortably", "type": "adv", "phonetic": "/ˈkʌmfərtəbli/", "meaning": "thoải mái" },
//   { "word": "consist", "type": "v", "phonetic": "/kənˈsɪst/", "meaning": "gồm có" },
//   { "word": "directions", "type": "n", "phonetic": "/dəˈrekʃənz/", "meaning": "hướng dẫn" },
//   { "word": "dish", "type": "n", "phonetic": "/dɪʃ/", "meaning": "món ăn" },
//   { "word": "freshness", "type": "n", "phonetic": "/ˈfreʃnəs/", "meaning": "độ tươi" },
//   { "word": "frozen", "type": "adj", "phonetic": "/ˈfroʊzn/", "meaning": "(thực phẩm) đông lạnh" },
//   { "word": "generate", "type": "v", "phonetic": "/ˈdʒenəreɪt/", "meaning": "tạo ra" },
//   { "word": "in accordance with", "type": "phr", "phonetic": "/ɪn əˈkɔːrdəns wɪð/", "meaning": "phù hợp với" },
//   { "word": "laundry", "type": "n", "phonetic": "/ˈlɔːndri/", "meaning": "giặt ủi" },
//   { "word": "leading", "type": "adj", "phonetic": "/ˈliːdɪŋ/", "meaning": "hàng đầu" },
//   { "word": "otherwise", "type": "adv", "phonetic": "/ˈʌðərwaɪz/", "meaning": "nếu không thì" },
//   { "word": "prior to", "type": "prep", "phonetic": "/ˈpraɪər tu/", "meaning": "trước" },
//   { "word": "recipe", "type": "n", "phonetic": "/ˈresəpi/", "meaning": "công thức nấu ăn" },
//   { "word": "reservation", "type": "n", "phonetic": "/ˌrezərˈveɪʃən/", "meaning": "sự đặt phòng" },
//   { "word": "specify", "type": "v", "phonetic": "/ˈspesɪfaɪ/", "meaning": "chỉ rõ" },
//   { "word": "taste", "type": "n/v", "phonetic": "/teɪst/", "meaning": "mùi vị; nếm" },
//   { "word": "tray", "type": "n", "phonetic": "/treɪ/", "meaning": "cái khay" }
// ];

let vocabData = [];
const cloudinaryLinks = [];

const GOOGLE_TTS_KEY = 'AIzaSyAqO6_hgidkr_qandEMZUJlBcAhF3xOsUk';
const CLOUDINARY_UPLOAD_URL = 'https://api.cloudinary.com/v1_1/dlysxsbkj/auto/upload';
const CLOUDINARY_UPLOAD_PRESET = 'toeic_vocabulary'; // Đảm bảo đúng tên preset đã tạo trên Cloudinary
const CLOUDINARY_FOLDER = 'toeic_vocab';

async function loadVocabData() {
    try {
        const res = await fetch('data_question.json');
        vocabData = await res.json();
        cloudinaryLinks.length = vocabData.length;
        cloudinaryLinks.fill(null);
        renderTable();
    } catch (e) {
        alert('Không thể tải file data_question.json!');
    }
}

function renderTable() {
    const tbody = document.getElementById('vocabBody');
    tbody.innerHTML = '';
    vocabData.forEach((item, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${idx + 1}</td>
            <td><b>${item.word}</b></td>
            <td>${item.type}</td>
            <td>${item.phonetic}</td>
            <td>${item.meaning}</td>
            <td>
                <button class="btn" onclick="generateAudio(${idx})" id="btn-${idx}"><i class="fas fa-play"></i></button>
                <audio id="audio-${idx}" class="audio-player" controls style="display:none;"></audio>
                <span id="status-${idx}" class="status"></span>
            </td>
            <td>
                <button class="btn" onclick="downloadAudio(${idx})" id="dl-${idx}" disabled><i class="fas fa-download"></i></button>
                <button class="btn" onclick="uploadCloudinary(${idx})" id="cld-${idx}" disabled><i class="fas fa-cloud-upload-alt"></i></button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    // Thêm nút tải tất cả json và upload all
    if (!document.getElementById('btnWrapAll')) {
        const btnWrap = document.createElement('div');
        btnWrap.style = 'margin: 20px 0 0 0; float: right; display: flex; gap: 10px;';
        btnWrap.id = 'btnWrapAll';
        const btnUploadAll = document.createElement('button');
        btnUploadAll.className = 'btn';
        btnUploadAll.id = 'uploadAllBtn';
        btnUploadAll.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Tải tất cả lên Cloudinary';
        btnUploadAll.onclick = uploadAllCloudinary;
        const btnDownloadAll = document.createElement('button');
        btnDownloadAll.className = 'btn';
        btnDownloadAll.id = 'downloadAllBtn';
        btnDownloadAll.innerHTML = '<i class="fas fa-download"></i> Tải tất cả JSON (Cloudinary)';
        btnDownloadAll.onclick = downloadAllJson;
        btnWrap.appendChild(btnUploadAll);
        btnWrap.appendChild(btnDownloadAll);
        document.querySelector('.container').appendChild(btnWrap);
    }
}

async function generateAudio(idx) {
    const item = vocabData[idx];
    const btn = document.getElementById(`btn-${idx}`);
    const status = document.getElementById(`status-${idx}`);
    const audio = document.getElementById(`audio-${idx}`);
    const dlBtn = document.getElementById(`dl-${idx}`);
    const cldBtn = document.getElementById(`cld-${idx}`);
    const voice = document.getElementById('voiceSelect').value;
    btn.disabled = true;
    status.textContent = 'Đang tạo...';
    status.classList.remove('error');
    try {
        const text = item.word;
        const ssml = `<speak><voice name='${voice}'>${text}</voice></speak>`;
        const res = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                input: { ssml },
                voice: { languageCode: 'en-US', name: voice },
                audioConfig: { audioEncoding: 'MP3', speakingRate: 1.0 }
            })
        });
        const result = await res.json();
        if (result.audioContent) {
            const audioData = `data:audio/mp3;base64,${result.audioContent}`;
            audio.src = audioData;
            audio.style.display = 'inline-block';
            dlBtn.disabled = false;
            document.getElementById(`cld-${idx}`).disabled = false;
            status.textContent = '✔️ Thành công';
        } else {
            throw new Error(result.error?.message || 'Không tạo được audio');
        }
    } catch (e) {
        status.textContent = 'Lỗi';
        status.classList.add('error');
    }
    btn.disabled = false;
}

async function generateAllAudio() {
    for (let i = 0; i < vocabData.length; i++) {
        await generateAudio(i);
    }
}

async function uploadCloudinary(idx) {
    const audio = document.getElementById(`audio-${idx}`);
    const btn = document.getElementById(`cld-${idx}`);
    const status = document.getElementById(`status-${idx}`);
    if (!audio.src) return;
    btn.disabled = true;
    status.textContent = 'Đang upload...';
    status.classList.remove('error');
    try {
        // Convert base64 to blob
        const base64 = audio.src.split(',')[1];
        const byteCharacters = atob(base64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const audioBlob = new Blob([byteArray], { type: 'audio/mp3' });
        const formData = new FormData();
        formData.append('file', audioBlob, `${vocabData[idx].word}.mp3`);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
        formData.append('folder', CLOUDINARY_FOLDER);
        formData.append('resource_type', 'auto');
        // Log formData keys/values
        for (let pair of formData.entries()) {
            console.log('FormData:', pair[0], pair[1]);
        }
        console.log('Uploading to:', CLOUDINARY_UPLOAD_URL);
        const response = await fetch(CLOUDINARY_UPLOAD_URL, {
            method: 'POST',
            body: formData
        });
        console.log('Cloudinary response status:', response.status);
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Cloudinary error response:', errorText);
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        const result = await response.json();
        console.log('Cloudinary result:', result);
        if (result.secure_url) {
            cloudinaryLinks[idx] = result.secure_url;
            status.textContent = '☁️ Đã upload';
            btn.innerHTML = '<i class="fas fa-check"></i>';
        } else {
            throw new Error(result.error?.message || 'Không nhận được URL từ Cloudinary');
        }
    } catch (e) {
        status.textContent = 'Lỗi upload';
        status.classList.add('error');
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
        console.error('Upload error:', e);
    }
    btn.disabled = false;
}

async function uploadAllCloudinary() {
    for (let i = 0; i < vocabData.length; i++) {
        if (document.getElementById(`cld-${i}`) && !cloudinaryLinks[i]) {
            await uploadCloudinary(i);
        }
    }
}

function downloadAudio(idx) {
    const audio = document.getElementById(`audio-${idx}`);
    if (!audio.src) return;
    const a = document.createElement('a');
    a.href = audio.src;
    a.download = `${vocabData[idx].word}.mp3`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

function downloadAllJson() {
    // Tạo mảng object gồm từ vựng + link cloudinary nếu có
    const arr = vocabData.map((item, idx) => ({
        ...item,
        audio: cloudinaryLinks[idx] || null
    }));
    const blob = new Blob([JSON.stringify(arr, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `toeic_vocab_with_audio_${new Date().getTime()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

loadVocabData();
</script>
</body>
</html> 