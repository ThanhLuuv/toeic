<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC Part 1 - Audio & Image Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            margin-bottom: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            width: 100%;
            transition: all 0.3s;
        }

        .file-input-wrapper:hover {
            background: #e9ecef;
            border-color: #495057;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #fd7e14);
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #555;
        }

        .questions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .question-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-title {
            font-weight: 600;
            color: #333;
        }

        .question-number {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .image-container {
            width: 100%;
            max-width: 300px;
            height: 200px;
            background: #e9ecef;
            border-radius: 8px;
            margin: 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #dee2e6;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-placeholder {
            color: #6c757d;
            text-align: center;
        }

        .choices-container {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e1e5e9;
        }

        .choice-item {
            margin-bottom: 8px;
            font-size: 13px;
            padding: 5px;
            border-radius: 4px;
        }

        .choice-correct {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }

        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .audio-player {
            width: 100%;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
        }

        .audio-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.8;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .vocabulary-section {
            background: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #e1e5e9;
        }

        .vocab-item {
            font-size: 12px;
            margin: 2px 0;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .vocab-correct {
            background: #d4edda;
        }

        .vocab-incorrect {
            background: #f8d7da;
        }

        @media (max-width: 768px) {
            .questions-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .audio-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
            }

            .audio-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-camera"></i> TOEIC Part 1 Audio & Image Generator</h1>
            <p>T·∫°o ·∫£nh v√† audio cho TOEIC Part 1 b·∫±ng AI (Gemini + Google TTS)<br>
            <small style="opacity: 0.8;">üñºÔ∏è T·∫°o ·∫£nh ƒëen tr·∫Øng b·∫±ng Gemini API | üéµ T·∫°o audio v·ªõi 3 l·ª±a ch·ªçn A, B, C<br>
            ‚òÅÔ∏è Auto upload l√™n Cloudinary | üìÑ Export JSON v·ªõi image & audio URLs</small></p>
        </div>

        <div class="stats" id="statsContainer" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalQuestions">0</div>
                <div class="stat-label">C√¢u h·ªèi</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="imagesGenerated">0</div>
                <div class="stat-label">·∫¢nh ƒë√£ t·∫°o</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="audioGenerated">0</div>
                <div class="stat-label">Audio ƒë√£ t·∫°o</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uploadedToCloudinary">0</div>
                <div class="stat-label">Upload Cloudinary</div>
            </div>
        </div>

        <div class="card">
            <div class="input-section">
                <h2><i class="fas fa-upload"></i> T·∫£i d·ªØ li·ªáu</h2>
                
                <div class="input-group">
                    <label>T·∫£i d·ªØ li·ªáu JSON</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="jsonFile" accept=".json">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2em; color: #667eea; margin-bottom: 10px;"></i>
                        <div>Ch·ªçn file JSON ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y</div>
                        <small style="color: #6c757d;">H·ªó tr·ª£ file .json v·ªõi format Part 1</small>
                    </div>
                </div>

                <div class="input-group">
                    <label for="jsonInput">Ho·∫∑c d√°n JSON tr·ª±c ti·∫øp</label>
                    <textarea id="jsonInput" rows="8" placeholder="D√°n n·ªôi dung JSON v√†o ƒë√¢y..."></textarea>
                </div>

                <div>
                    <button class="btn" onclick="loadData()">
                        <i class="fas fa-upload"></i> T·∫£i d·ªØ li·ªáu
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()">
                        <i class="fas fa-trash"></i> X√≥a d·ªØ li·ªáu
                    </button>
                </div>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">ƒêang x·ª≠ l√Ω...</div>
            </div>

            <div id="alertContainer"></div>
        </div>

        <div class="card" id="questionsContainer" style="display: none;">
            <div style="display: flex; justify-content: space-between; flex-direction: column; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-list"></i> Danh s√°ch c√¢u h·ªèi Part 1</h2>
                <div style="margin-top: 15px;">
                    <button class="btn btn-warning" onclick="generateAllImages()" id="generateImagesBtn" disabled>
                        <i class="fas fa-image"></i> T·∫°o t·∫•t c·∫£ ·∫¢nh
                    </button>
                    <button class="btn btn-success" onclick="generateAllAudio()" id="generateAudioBtn" disabled>
                        <i class="fas fa-volume-up"></i> T·∫°o t·∫•t c·∫£ Audio
                    </button>
                    <button class="btn btn-secondary" onclick="downloadAllAssets()" id="downloadAllBtn" disabled>
                        <i class="fas fa-download"></i> T·∫£i MP3 t·∫•t c·∫£
                    </button>
                    <button class="btn btn-danger" onclick="clearAllAssets()" id="clearAssetsBtn">
                        <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£ Assets
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e1e5e9; width: 100%;">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Batch Processing - Upload t·∫•t c·∫£ l√™n Cloudinary</h3>
                    <p style="color: #6c757d; margin-bottom: 15px;">
                        <small>üí° ƒê·ªÉ x·ª≠ l√Ω h√†ng lo·∫°t: Upload t·∫•t c·∫£ ·∫£nh + audio l√™n Cloudinary v√† t·∫°o m·ªôt file JSON ch·ª©a t·∫•t c·∫£ items<br>
                        üìå Kh√°c bi·ªát: N√∫t "T·∫£i JSON" ·ªü m·ªói c√¢u s·∫Ω t·ª± ƒë·ªông upload + t·∫°o JSON cho t·ª´ng item ri√™ng l·∫ª</small>
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="uploadAllToCloudinary()" id="uploadCloudinaryBtn" disabled>
                            <i class="fas fa-cloud-upload-alt"></i> Batch Upload t·∫•t c·∫£ l√™n Cloudinary
                        </button>
                        <button class="btn btn-success" onclick="downloadJsonWithCloudinaryUrls()" id="downloadJsonBtn" disabled>
                            <i class="fas fa-download"></i> T·∫£i JSON Array (t·∫•t c·∫£ items)
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="questions-grid" id="questionsList"></div>
        </div>
    </div>

    <script>
        // Bi·∫øn to√†n c·ª•c
        const GOOGLE_TTS_KEY = 'AIzaSyAqO6_hgidkr_qandEMZUJlBcAhF3xOsUk';
        const GEMINI_API_KEY = 'AIzaSyBhEX-SGF9m-xfmjfwkaWCoysypwhnlsKE';
        const CLOUDINARY_UPLOAD_URL_IMAGE = 'https://api.cloudinary.com/v1_1/dlysxsbkj/image/upload';
        const CLOUDINARY_UPLOAD_URL_AUDIO = 'https://api.cloudinary.com/v1_1/dlysxsbkj/auto/upload';
        const CLOUDINARY_UPLOAD_PRESET = 'toeic_part3';

        let generatedQuestions = [];
        let generatedImages = [];
        let generatedAudio = [];
        let cloudinaryImageUrls = [];
        let cloudinaryAudioUrls = [];
        let imagesGeneratedCount = 0;
        let audioGeneratedCount = 0;
        let uploadedToCloudinaryCount = 0;

        // Kh·ªüi t·∫°o
        document.addEventListener('DOMContentLoaded', function() {
            // X·ª≠ l√Ω drag & drop
            const fileWrapper = document.querySelector('.file-input-wrapper');
            
            fileWrapper.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#495057';
                this.style.background = '#e9ecef';
            });
            
            fileWrapper.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#667eea';
                this.style.background = '#f8f9fa';
            });
            
            fileWrapper.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#667eea';
                this.style.background = '#f8f9fa';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('jsonFile').files = files;
                    handleFileSelect(files[0]);
                }
            });

            // X·ª≠ l√Ω ch·ªçn file
            document.getElementById('jsonFile').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        });

        // X·ª≠ l√Ω file ƒë∆∞·ª£c ch·ªçn
        function handleFileSelect(file) {
            if (file.type !== 'application/json') {
                showAlert('error', 'Vui l√≤ng ch·ªçn file JSON h·ª£p l·ªá!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('jsonInput').value = e.target.result;
                showAlert('success', `ƒê√£ t·∫£i file: ${file.name}`);
            };
            reader.readAsText(file);
        }

        // T·∫£i v√† x·ª≠ l√Ω d·ªØ li·ªáu
        function loadData() {
            const jsonInput = document.getElementById('jsonInput').value.trim();

            if (!jsonInput) {
                showAlert('error', 'Vui l√≤ng nh·∫≠p ho·∫∑c t·∫£i d·ªØ li·ªáu JSON!');
                return;
            }

            try {
                const data = JSON.parse(jsonInput);
                
                // Ki·ªÉm tra d·ªØ li·ªáu c√≥ ph·∫£i l√† array kh√¥ng
                if (Array.isArray(data)) {
                    generatedQuestions = data;
                } else {
                    generatedQuestions = [data];
                }

                // Validate d·ªØ li·ªáu
                if (!validateData(generatedQuestions)) {
                    return;
                }

                generatedImages = new Array(generatedQuestions.length).fill(null);
                generatedAudio = new Array(generatedQuestions.length).fill(null);
                cloudinaryImageUrls = new Array(generatedQuestions.length).fill(null);
                cloudinaryAudioUrls = new Array(generatedQuestions.length).fill(null);
                imagesGeneratedCount = 0;
                audioGeneratedCount = 0;
                uploadedToCloudinaryCount = 0;

                // Load existing images and audio if available
                generatedQuestions.forEach((q, index) => {
                    if (q.image) {
                        generatedImages[index] = q.image;
                        cloudinaryImageUrls[index] = q.image;
                        imagesGeneratedCount++;
                    }
                    if (q.audio) {
                        generatedAudio[index] = q.audio;
                        cloudinaryAudioUrls[index] = q.audio;
                        audioGeneratedCount++;
                    }
                });

                displayQuestions();
                updateStats();
                showAlert('success', `ƒê√£ t·∫£i th√†nh c√¥ng ${generatedQuestions.length} c√¢u h·ªèi Part 1! üñºÔ∏è T·∫°o ·∫¢nh ‚Üí üéµ T·∫°o Audio ‚Üí üìÑ T·∫£i JSON`);
                
            } catch (error) {
                showAlert('error', 'D·ªØ li·ªáu JSON kh√¥ng h·ª£p l·ªá: ' + error.message);
            }
        }

        // Validate d·ªØ li·ªáu
        function validateData(data) {
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                if (!item.imageDescription || !item.choices) {
                    showAlert('error', `D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá t·∫°i item ${i + 1}: thi·∫øu imageDescription ho·∫∑c choices`);
                    return false;
                }
            }
            return true;
        }

        // Hi·ªÉn th·ªã danh s√°ch c√¢u h·ªèi
        function displayQuestions() {
            const container = document.getElementById('questionsList');
            container.innerHTML = '';

            generatedQuestions.forEach((question, index) => {
                const card = createQuestionCard(question, index);
                container.appendChild(card);
            });

            document.getElementById('questionsContainer').style.display = 'block';
            document.getElementById('statsContainer').style.display = 'grid';
            document.getElementById('generateImagesBtn').disabled = false;
        }

        // T·∫°o card c√¢u h·ªèi
        function createQuestionCard(question, index) {
            const card = document.createElement('div');
            card.className = 'question-card';
            
            const hasImage = generatedImages[index] || question.image;
            const hasAudio = generatedAudio[index] || question.audio;
            
            card.innerHTML = `
                <div class="question-header">
                    <div class="question-title">C√¢u ${index + 1}</div>
                    <div class="question-number">Q${question.questionNumber || index + 1}</div>
                </div>
                
                <div class="image-container" id="image-container-${index}">
                    ${hasImage ? 
                        `<img src="${hasImage}" alt="Question ${index + 1}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <div class="image-placeholder" style="display: none;">
                            <i class="fas fa-image fa-2x"></i><br>L·ªói t·∫£i ·∫£nh
                         </div>` : 
                        `<div class="image-placeholder">
                            <i class="fas fa-image fa-2x"></i><br>Ch∆∞a c√≥ ·∫£nh
                         </div>`
                    }
                </div>
                
                <div style="margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 5px; font-size: 13px;">
                    <strong>M√¥ t·∫£ ·∫£nh:</strong> ${question.imageDescription}
                </div>
                
                <div class="choices-container">
                    <strong>L·ª±a ch·ªçn:</strong><br>
                    <div class="choice-item ${question.correctAnswer === 'A' ? 'choice-correct' : ''}">
                        <strong>A:</strong> ${question.choices.A}
                    </div>
                    <div class="choice-item ${question.correctAnswer === 'B' ? 'choice-correct' : ''}">
                        <strong>B:</strong> ${question.choices.B}
                    </div>
                    <div class="choice-item ${question.correctAnswer === 'C' ? 'choice-correct' : ''}">
                        <strong>C:</strong> ${question.choices.C}
                    </div>
                    <small style="color: #28a745;"><strong>ƒê√°p √°n ƒë√∫ng:</strong> ${question.correctAnswer}</small>
                </div>

                ${question.subjectVocabulary ? `
                <div class="vocabulary-section">
                    <strong style="font-size: 12px;">Subject Vocab:</strong><br>
                    ${question.subjectVocabulary.map(v => 
                        `<span class="vocab-item ${v.isCorrect ? 'vocab-correct' : 'vocab-incorrect'}">${v.word} (${v.meaning})</span>`
                    ).join(' ')}
                </div>` : ''}

                ${question.descriptiveVocabulary ? `
                <div class="vocabulary-section">
                    <strong style="font-size: 12px;">Descriptive Vocab:</strong><br>
                    ${question.descriptiveVocabulary.map(v => 
                        `<span class="vocab-item ${v.isCorrect ? 'vocab-correct' : 'vocab-incorrect'}">${v.word} (${v.meaning})</span>`
                    ).join(' ')}
                </div>` : ''}
                
                <div class="audio-controls">
                    <audio class="audio-player" id="audio-${index}" controls style="display: ${hasAudio ? 'block' : 'none'};">
                        <source src="${hasAudio || ''}" type="audio/mpeg">
                        Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.
                    </audio>
                    <div class="audio-buttons">
                        <button class="btn btn-warning" onclick="generateSingleImage(${index})" id="img-btn-${index}">
                            <i class="fas fa-image"></i> ${hasImage ? 'T·∫°o l·∫°i ·∫¢nh' : 'T·∫°o ·∫¢nh'}
                        </button>
                        <button class="btn" onclick="generateSingleAudio(${index})" id="audio-btn-${index}" ${hasImage ? '' : 'disabled'}>
                            <i class="fas fa-volume-up"></i> ${hasAudio ? 'T·∫°o l·∫°i Audio' : 'T·∫°o Audio'}
                        </button>
                        <button class="btn btn-secondary" onclick="downloadSingleJson(${index})" id="download-${index}" disabled>
                            <i class="fas fa-download"></i> T·∫£i JSON
                        </button>
                    </div>
                </div>
            `;
            
            // Enable download button if both image and audio exist
            if (hasImage && hasAudio) {
                setTimeout(() => {
                    document.getElementById(`download-${index}`).disabled = false;
                }, 100);
            }
            
            return card;
        }

        // Upload ·∫£nh l√™n Cloudinary
        async function uploadImageToCloudinary(base64Image) {
            try {
                const formData = new FormData();
                formData.append('file', base64Image);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', 'toeic_part1_images');

                const response = await fetch(CLOUDINARY_UPLOAD_URL_IMAGE, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.secure_url) {
                    return result.secure_url;
                } else {
                    throw new Error(result.error?.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Cloudinary image upload error:', error);
                throw error;
            }
        }

        // Upload audio l√™n Cloudinary
        async function uploadAudioToCloudinary(base64Audio) {
            try {
                function base64ToBlob(base64, mime = 'audio/mp3') {
                    const byteString = atob(base64.split(',')[1] || base64);
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    return new Blob([ab], { type: mime });
                }
                
                const blob = base64ToBlob(base64Audio, 'audio/mp3');
                const formData = new FormData();
                formData.append('file', blob);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', 'toeic_part1_audio');
                formData.append('resource_type', 'auto');

                const response = await fetch(CLOUDINARY_UPLOAD_URL_AUDIO, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.secure_url) {
                    return result.secure_url;
                } else {
                    throw new Error(result.error?.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Cloudinary audio upload error:', error);
                throw error;
            }
        }

        // T·∫°o ·∫£nh cho m·ªôt c√¢u c·ª• th·ªÉ
        async function generateSingleImage(index) {
            const btn = document.getElementById(`img-btn-${index}`);
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';

            try {
                const question = generatedQuestions[index];
                const prompt = `${question.imageDescription}. IMPORTANT: Create a black and white photograph (monochrome, grayscale, no color), realistic and professional quality, suitable for TOEIC test, documentary style. The photo should always depict a Western setting, specifically in England or the USA. The image must look natural and unposed, similar to scenes used in standardized English exams. Do not include any color. The setting, people, and objects should clearly reflect either British or American environments.`;

                // G·ªçi Gemini ƒë·ªÉ t·∫°o ·∫£nh
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instances: { prompt },
                        parameters: { sampleCount: 1 }
                    })
                });

                const result = await response.json();

                if (result.predictions?.[0]?.bytesBase64Encoded) {
                    const base64 = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    
                    // Upload l√™n Cloudinary
                    const imageUrl = await uploadImageToCloudinary(base64);
                    generatedImages[index] = imageUrl;
                    cloudinaryImageUrls[index] = imageUrl;
                    generatedQuestions[index].image = imageUrl;
                    
                    // Update UI
                    updateImageDisplay(index, imageUrl);
                    if (!generatedAudio[index]) imagesGeneratedCount++;
                    
                    updateStats();
                    btn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ t·∫°o';
                    btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    
                    // Enable audio button
                    document.getElementById(`audio-btn-${index}`).disabled = false;
                    
                    showAlert('success', `T·∫°o ·∫£nh th√†nh c√¥ng cho c√¢u ${index + 1}!`);
                } else {
                    throw new Error('Image generation failed');
                }

            } catch (error) {
                showAlert('error', `L·ªói khi t·∫°o ·∫£nh: ${error.message}`);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> L·ªói';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            btn.disabled = false;
        }

        // Fix pronunciation function for TTS
        function fixPronunciation(text) {
            let fixedText = text;
            
            // S·ª≠a "a man" - ph√°t √¢m "…ô" (schwa) thay v√¨ "e…™"
            fixedText = fixedText.replace(/\ba man\b/gi, '<phoneme alphabet="ipa" ph="…ô m√¶n">a man</phoneme>');
            fixedText = fixedText.replace(/\ba woman\b/gi, '<phoneme alphabet="ipa" ph="…ô Ààw äm…ôn">a woman</phoneme>');
            fixedText = fixedText.replace(/\ba person\b/gi, '<phoneme alphabet="ipa" ph="…ô Ààp…úrs…ôn">a person</phoneme>');
            fixedText = fixedText.replace(/\ba boy\b/gi, '<phoneme alphabet="ipa" ph="…ô b…î…™">a boy</phoneme>');
            fixedText = fixedText.replace(/\ba girl\b/gi, '<phoneme alphabet="ipa" ph="…ô …°…úrl">a girl</phoneme>');
            fixedText = fixedText.replace(/\ba dog\b/gi, '<phoneme alphabet="ipa" ph="…ô d…î…°">a dog</phoneme>');
            fixedText = fixedText.replace(/\ba cat\b/gi, '<phoneme alphabet="ipa" ph="…ô k√¶t">a cat</phoneme>');
            fixedText = fixedText.replace(/\ba book\b/gi, '<phoneme alphabet="ipa" ph="…ô b äk">a book</phoneme>');
            fixedText = fixedText.replace(/\ba house\b/gi, '<phoneme alphabet="ipa" ph="…ô ha äs">a house</phoneme>');
            fixedText = fixedText.replace(/\ba car\b/gi, '<phoneme alphabet="ipa" ph="…ô k…ër">a car</phoneme>');
            
            return fixedText;
        }

        // T·∫°o audio cho m·ªôt c√¢u c·ª• th·ªÉ
        async function generateSingleAudio(index) {
            const btn = document.getElementById(`audio-btn-${index}`);
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';

            try {
                const question = generatedQuestions[index];
                const questionNumber = question.questionNumber || (index + 1);
                
                let questionText = `Look at picture number ${questionNumber}.`;
                let answerA = fixPronunciation(question.choices.A || '');
                let answerB = fixPronunciation(question.choices.B || '');
                let answerC = fixPronunciation(question.choices.C || '');
                
                questionText = fixPronunciation(questionText);
                
                const ssmlContent = `
                    <speak>
                        <voice name="en-US-Wavenet-D">
                            <prosody rate="slow" pitch="medium">
                                ${questionText}
                            </prosody>
                            <break time="1.2s"/>
                           
                            <prosody rate="medium" pitch="medium">
                                A. ${answerA}
                            </prosody>
                            <break time="0.8s"/>
                           
                            <prosody rate="medium" pitch="medium">
                                B. ${answerB}
                            </prosody>
                            <break time="0.8s"/>
                           
                            <prosody rate="medium" pitch="medium">
                                C. ${answerC}
                            </prosody>
                        </voice>
                    </speak>
                `;

                const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        input: { ssml: ssmlContent },
                        voice: { languageCode: 'en-US', name: 'en-US-Wavenet-D' },
                        audioConfig: {
                            audioEncoding: 'MP3',
                            speakingRate: 0.85,
                            pitch: 0.0
                        }
                    })
                });

                const result = await response.json();

                if (result.audioContent) {
                    const base64Audio = `data:audio/mp3;base64,${result.audioContent}`;
                    
                    // Upload l√™n Cloudinary
                    const audioUrl = await uploadAudioToCloudinary(base64Audio);
                    generatedAudio[index] = audioUrl;
                    cloudinaryAudioUrls[index] = audioUrl;
                    generatedQuestions[index].audio = audioUrl;
                    
                    // Update UI
                    updateAudioPlayer(index, audioUrl);
                    audioGeneratedCount++;
                    
                    updateStats();
                    btn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ t·∫°o';
                    btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    
                    // Enable download button if image also exists
                    if (generatedImages[index]) {
                        document.getElementById(`download-${index}`).disabled = false;
                    }
                    
                    showAlert('success', `T·∫°o audio th√†nh c√¥ng cho c√¢u ${index + 1}!`);
                } else {
                    throw new Error(result.error?.message || 'Unknown error');
                }

            } catch (error) {
                showAlert('error', `L·ªói khi t·∫°o audio: ${error.message}`);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> L·ªói';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            btn.disabled = false;
        }

        // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ·∫£nh
        function updateImageDisplay(index, imageUrl) {
            const container = document.getElementById(`image-container-${index}`);
            container.innerHTML = `
                <img src="${imageUrl}" alt="Question ${index + 1}" style="width: 100%; height: 100%; object-fit: cover;">
            `;
        }

        // C·∫≠p nh·∫≠t audio player
        function updateAudioPlayer(index, audioUrl) {
            const audioPlayer = document.getElementById(`audio-${index}`);
            audioPlayer.src = audioUrl;
            audioPlayer.style.display = 'block';
        }

        // T·∫°o t·∫•t c·∫£ ·∫£nh
        async function generateAllImages() {
            const btn = document.getElementById('generateImagesBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';

            try {
                updateProgress(10, "B·∫Øt ƒë·∫ßu t·∫°o ·∫£nh...");
                
                for (let i = 0; i < generatedQuestions.length; i++) {
                    if (!generatedImages[i]) {
                        updateProgress(10 + (i * 40 / generatedQuestions.length), `T·∫°o ·∫£nh ${i + 1}/${generatedQuestions.length}...`);
                        await generateSingleImage(i);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }

                updateProgress(50, "Ho√†n t·∫•t t·∫°o ·∫£nh!");
                btn.innerHTML = '<i class="fas fa-check"></i> Ho√†n th√†nh';
                btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                document.getElementById('generateAudioBtn').disabled = false;
                
            } catch (error) {
                showAlert('error', 'C√≥ l·ªói x·∫£y ra khi t·∫°o ·∫£nh: ' + error.message);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> C√≥ l·ªói';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            btn.disabled = false;
        }

        // T·∫°o t·∫•t c·∫£ audio
        async function generateAllAudio() {
            const btn = document.getElementById('generateAudioBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';

            try {
                updateProgress(50, "B·∫Øt ƒë·∫ßu t·∫°o audio...");
                
                for (let i = 0; i < generatedQuestions.length; i++) {
                    if (!generatedAudio[i]) {
                        updateProgress(50 + (i * 50 / generatedQuestions.length), `T·∫°o audio ${i + 1}/${generatedQuestions.length}...`);
                        await generateSingleAudio(i);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                }

                updateProgress(100, "Ho√†n t·∫•t t·∫°o audio!");
                btn.innerHTML = '<i class="fas fa-check"></i> Ho√†n th√†nh';
                btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                document.getElementById('downloadAllBtn').disabled = false;
                document.getElementById('uploadCloudinaryBtn').disabled = false;
                
            } catch (error) {
                showAlert('error', 'C√≥ l·ªói x·∫£y ra khi t·∫°o audio: ' + error.message);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> C√≥ l·ªói';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            btn.disabled = false;
        }

        // Upload t·∫•t c·∫£ l√™n Cloudinary (batch)
        async function uploadAllToCloudinary() {
            const btn = document.getElementById('uploadCloudinaryBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang upload...';

            try {
                updateProgress(10, "B·∫Øt ƒë·∫ßu upload l√™n Cloudinary...");
                
                // Count assets already uploaded
                let alreadyUploaded = 0;
                for (let i = 0; i < generatedQuestions.length; i++) {
                    if (cloudinaryImageUrls[i] && cloudinaryAudioUrls[i]) {
                        alreadyUploaded++;
                    }
                }

                uploadedToCloudinaryCount = alreadyUploaded;
                updateProgress(100, `Ho√†n t·∫•t! ${uploadedToCloudinaryCount} items ƒë√£ c√≥ ƒë·∫ßy ƒë·ªß assets tr√™n Cloudinary.`);
                
                btn.innerHTML = '<i class="fas fa-check"></i> Upload ho√†n t·∫•t';
                btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                document.getElementById('downloadJsonBtn').disabled = false;
                updateStats();
                
            } catch (error) {
                showAlert('error', 'C√≥ l·ªói khi upload l√™n Cloudinary: ' + error.message);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> L·ªói';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            btn.disabled = false;
        }

        // T·∫£i JSON cho m·ªôt c√¢u c·ª• th·ªÉ
        async function downloadSingleJson(index) {
            const downloadBtn = document.getElementById(`download-${index}`);
            
            if (!generatedImages[index] || !generatedAudio[index]) {
                showAlert('error', 'C·∫ßn c√≥ c·∫£ ·∫£nh v√† audio ƒë·ªÉ t·∫£i JSON!');
                return;
            }

            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

            try {
                const question = generatedQuestions[index];
                
                // T·∫°o JSON theo format y√™u c·∫ßu
                const jsonItem = {
                    questionNumber: question.questionNumber || (index + 1),
                    imageDescription: question.imageDescription,
                    subjectVocabulary: question.subjectVocabulary || [],
                    descriptiveVocabulary: question.descriptiveVocabulary || [],
                    choices: question.choices,
                    choicesVi: question.choicesVi || {},
                    correctAnswer: question.correctAnswer,
                    explanation: question.explanation || "",
                    traps: question.traps || "",
                    image: cloudinaryImageUrls[index] || generatedImages[index],
                    audio: cloudinaryAudioUrls[index] || generatedAudio[index]
                };

                // T·∫°o v√† t·∫£i xu·ªëng file JSON
                const jsonString = JSON.stringify(jsonItem, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `toeic_part1_question_${index + 1}_${Date.now()}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                downloadBtn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ t·∫£i JSON';
                downloadBtn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                showAlert('success', `ƒê√£ t·∫£i JSON cho c√¢u ${index + 1} v·ªõi image & audio URLs!`);
                
            } catch (error) {
                showAlert('error', `L·ªói khi x·ª≠ l√Ω c√¢u ${index + 1}: ${error.message}`);
                downloadBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> L·ªói';
                downloadBtn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            downloadBtn.disabled = false;
        }

        // T·∫£i JSON v·ªõi t·∫•t c·∫£ Cloudinary URLs
        function downloadJsonWithCloudinaryUrls() {
            const jsonData = [];
            
            generatedQuestions.forEach((question, index) => {
                if (cloudinaryImageUrls[index] && cloudinaryAudioUrls[index]) {
                    const jsonItem = {
                        questionNumber: question.questionNumber || (index + 1),
                        imageDescription: question.imageDescription,
                        subjectVocabulary: question.subjectVocabulary || [],
                        descriptiveVocabulary: question.descriptiveVocabulary || [],
                        choices: question.choices,
                        choicesVi: question.choicesVi || {},
                        correctAnswer: question.correctAnswer,
                        explanation: question.explanation || "",
                        traps: question.traps || "",
                        image: cloudinaryImageUrls[index],
                        audio: cloudinaryAudioUrls[index]
                    };
                    
                    jsonData.push(jsonItem);
                }
            });

            // T·∫°o file JSON v√† t·∫£i xu·ªëng
            const jsonString = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `toeic_part1_complete_${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showAlert('success', `ƒê√£ t·∫£i xu·ªëng JSON v·ªõi ${jsonData.length} items c√≥ ƒë·∫ßy ƒë·ªß image & audio!`);
        }

        // T·∫£i xu·ªëng t·∫•t c·∫£ MP3
        function downloadAllAssets() {
            const validAudio = generatedAudio.filter(audio => audio !== null);
            
            if (validAudio.length === 0) {
                showAlert('error', 'Ch∆∞a c√≥ audio n√†o ƒë∆∞·ª£c t·∫°o!');
                return;
            }

            validAudio.forEach((audio, i) => {
                if (audio) {
                    setTimeout(() => {
                        const link = document.createElement('a');
                        link.href = audio;
                        link.download = `part1_question_${i + 1}.mp3`;
                        link.click();
                    }, i * 500);
                }
            });

            showAlert('success', `ƒêang t·∫£i xu·ªëng ${validAudio.length} file audio...`);
        }

        // X√≥a t·∫•t c·∫£ assets
        function clearAllAssets() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ ·∫£nh v√† audio ƒë√£ t·∫°o?')) {
                generatedImages = new Array(generatedQuestions.length).fill(null);
                generatedAudio = new Array(generatedQuestions.length).fill(null);
                cloudinaryImageUrls = new Array(generatedQuestions.length).fill(null);
                cloudinaryAudioUrls = new Array(generatedQuestions.length).fill(null);
                imagesGeneratedCount = 0;
                audioGeneratedCount = 0;
                uploadedToCloudinaryCount = 0;

                // Reset UI
                displayQuestions();
                updateStats();
                
                // Reset buttons
                document.getElementById('generateImagesBtn').disabled = false;
                document.getElementById('generateAudioBtn').disabled = true;
                document.getElementById('downloadAllBtn').disabled = true;
                document.getElementById('uploadCloudinaryBtn').disabled = true;
                document.getElementById('downloadJsonBtn').disabled = true;
                
                showAlert('success', 'ƒê√£ x√≥a t·∫•t c·∫£ assets! H√£y t·∫°o l·∫°i t·ª´ ƒë·∫ßu.');
            }
        }

        // X√≥a d·ªØ li·ªáu
        function clearData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu?')) {
                generatedQuestions = [];
                generatedImages = [];
                generatedAudio = [];
                cloudinaryImageUrls = [];
                cloudinaryAudioUrls = [];
                imagesGeneratedCount = 0;
                audioGeneratedCount = 0;
                uploadedToCloudinaryCount = 0;
                
                document.getElementById('jsonInput').value = '';
                document.getElementById('jsonFile').value = '';
                document.getElementById('questionsContainer').style.display = 'none';
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('alertContainer').innerHTML = '';
                
                showAlert('success', 'ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu!');
            }
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStats() {
            document.getElementById('totalQuestions').textContent = generatedQuestions.length;
            document.getElementById('imagesGenerated').textContent = imagesGeneratedCount;
            document.getElementById('audioGenerated').textContent = audioGeneratedCount;
            document.getElementById('uploadedToCloudinary').textContent = uploadedToCloudinaryCount;
        }

        // C·∫≠p nh·∫≠t progress
        function updateProgress(percent, message) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = message;
            
            if (percent >= 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            let alertClass, icon;
            
            switch(type) {
                case 'error':
                    alertClass = 'alert-error';
                    icon = 'exclamation-triangle';
                    break;
                case 'success':
                    alertClass = 'alert-success';
                    icon = 'check-circle';
                    break;
                case 'info':
                    alertClass = 'alert-info';
                    icon = 'info-circle';
                    break;
                default:
                    alertClass = 'alert-info';
                    icon = 'info-circle';
            }
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.innerHTML = `
                <i class="fas fa-${icon}"></i>
                ${message}
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>