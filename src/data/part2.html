<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC Part 2 Generator - Question & Response</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            margin-bottom: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            width: 100%;
            transition: all 0.3s;
        }

        .file-input-wrapper:hover {
            background: #e9ecef;
            border-color: #495057;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #555;
        }

        .questions-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .question-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .voice-indicator {
            font-size: 0.9rem;
            color: #666;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .question-text {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }

        .choices-container {
            display: grid;
            gap: 8px;
        }

        .choice-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .choice-item.correct {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .choice-label {
            background: #667eea;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 10px;
        }

        .choice-item.correct .choice-label {
            background: #28a745;
        }

        .question-info {
            margin-top: 15px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .audio-player {
            width: 100%;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
        }

        .audio-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .audio-player {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .audio-controls audio {
            width: 100%;
            border-radius: 6px;
        }

        .download-section {
            background: #e8f5e8;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .download-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab-btn:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        kbd {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-family: monospace;
            border: 1px solid #dee2e6;
            box-shadow: 0 1px 0 rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .questions-preview {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .btn {
                margin: 2px 0;
            }
            
            .audio-buttons {
                flex-direction: column;
                gap: 8px;
            }
            
            .audio-buttons .btn {
                width: 100%;
            }
            
            .tab-btn {
                padding: 8px 15px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-headphones"></i> TOEIC Part 2 Generator</h1>
            <p>Question & Response - Generate Audio với Google TTS API + Cloudinary Upload</p>
        </div>

        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-number" id="totalQuestions">0</div>
                <div class="stat-label">Tổng số câu hỏi</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="audioGenerated">0</div>
                <div class="stat-label">Audio đã tạo</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cloudinaryUploads">0</div>
                <div class="stat-label">Cloudinary uploads</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="successRate">0%</div>
                <div class="stat-label">Tỷ lệ thành công</div>
            </div>
        </div>

        <div class="card">
            <div class="input-section">
                <h2><i class="fas fa-upload"></i> Tải dữ liệu</h2>
                
                <!-- Tab Navigation -->
                <div style="display: flex; margin-bottom: 15px; border-bottom: 2px solid #e9ecef;">
                    <button class="tab-btn active" onclick="switchTab('file')" id="fileTab">
                        <i class="fas fa-folder"></i> Upload File
                    </button>
                    <button class="tab-btn" onclick="switchTab('paste')" id="pasteTab">
                        <i class="fas fa-clipboard"></i> Paste JSON
                    </button>
                </div>

                <!-- File Upload Tab -->
                <div id="fileUploadTab" class="tab-content active">
                    <div class="input-group">
                        <label>Tải dữ liệu JSON</label>
                        <div class="file-input-wrapper" id="fileUpload">
                            <input type="file" id="fileInput" accept=".json">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2em; color: #667eea; margin-bottom: 10px;"></i>
                            <div>Chọn file JSON hoặc kéo thả vào đây</div>
                            <small style="color: #6c757d;">Hỗ trợ file .json</small>
                        </div>
                    </div>
                </div>

                <!-- Paste JSON Tab -->
                <div id="pasteJsonTab" class="tab-content">
                    <div class="input-group">
                        <label for="jsonInput">Hoặc dán JSON trực tiếp</label>
                        <textarea 
                            id="jsonInput" 
                            rows="8" 
                            placeholder="Dán nội dung JSON vào đây...&#10;[&#10;  {&#10;    &quot;id&quot;: 1,&#10;    &quot;question&quot;: &quot;Why is the printer not working?&quot;,&#10;    &quot;choices&quot;: {&#10;      &quot;A&quot;: &quot;It explains procedures.&quot;,&#10;      &quot;B&quot;: &quot;Because it's out of ink.&quot;,&#10;      &quot;C&quot;: &quot;Yes, I printed documents.&quot;&#10;    },&#10;    &quot;correctAnswer&quot;: &quot;B&quot;&#10;  }&#10;]"
                        ></textarea>
                    </div>
                </div>

                <div>
                    <button class="btn" onclick="loadData()">
                        <i class="fas fa-upload"></i> Tải dữ liệu
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()">
                        <i class="fas fa-trash"></i> Xóa dữ liệu
                    </button>
                    <button class="btn" id="generateBtn" onclick="generateAudio()" disabled>
                        <i class="fas fa-play"></i> Generate Audio
                    </button>
                </div>

                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 0.8rem; color: #666;">
                    <strong><i class="fas fa-lightbulb"></i> Shortcuts:</strong><br>
                    • <kbd>Ctrl + V</kbd> để chuyển sang paste tab<br>
                    • <kbd>Ctrl + Enter</kbd> để load JSON từ paste area
                </div>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Đang xử lý...</div>
            </div>

            <div id="alertContainer"></div>
        </div>

        <div class="card" id="questionsContainer" style="display: none;">
            <div style="display: flex; justify-content: space-between; flex-direction: column; align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-comments"></i> Danh sách câu hỏi Part 2</h2>
                <div>
                    <button class="btn btn-success" onclick="downloadGeneratedData()" id="downloadAllBtn" disabled>
                        <i class="fas fa-download"></i> Download JSON Array (tất cả câu)
                    </button>
                    <button class="btn btn-danger" onclick="clearAllAudio()" id="clearAudioBtn">
                        <i class="fas fa-trash"></i> Xóa tất cả Audio
                    </button>
                </div>
                <p style="color: #6c757d; margin-top: 10px; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> Mỗi câu hỏi có nút "Tải JSON" riêng để download từng file với Cloudinary URL
                </p>
            </div>
            
            <div class="questions-preview" id="questionsPreview"></div>

            <div class="download-section" id="downloadSection" style="display: none;">
                <h3>📥 Download Results</h3>
                <p>Audio đã được tạo và upload thành công lên Cloudinary!</p>
                <div class="download-buttons">
                    <button class="btn btn-success" onclick="downloadGeneratedData()">
                        <span>💾</span> Download JSON với Cloudinary URLs
                    </button>
                    <button class="btn btn-secondary" onclick="downloadIndividual()">
                        <span>📋</span> Download từng câu riêng lẻ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const GOOGLE_TTS_KEY = 'AIzaSyAqO6_hgidkr_qandEMZUJlBcAhF3xOsUk';
        const CLOUDINARY_UPLOAD_URL = 'https://api.cloudinary.com/v1_1/dlysxsbkj/auto/upload';
        const CLOUDINARY_UPLOAD_PRESET = 'toeic_part2';

        // Global variables
        let generatedQuestions = [];
        let generatedAudio = [];
        let totalQuestions = 0;
        let audioGenerated = 0;
        let cloudinaryUploads = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            updateStats();
            setupKeyboardShortcuts();
        });

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + V to switch to paste tab and focus textarea
                if ((e.ctrlKey || e.metaKey) && e.key === 'v' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    switchTab('paste');
                    setTimeout(() => {
                        document.getElementById('jsonInput').focus();
                    }, 100);
                }
                
                // Ctrl/Cmd + Enter to load from paste (when in textarea)
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && e.target.id === 'jsonInput') {
                    e.preventDefault();
                    loadData();
                }
            });
        }

        function setupFileUpload() {
            const fileWrapper = document.querySelector('.file-input-wrapper');
            
            fileWrapper.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#495057';
                this.style.background = '#e9ecef';
            });
            
            fileWrapper.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#667eea';
                this.style.background = '#f8f9fa';
            });
            
            fileWrapper.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#667eea';
                this.style.background = '#f8f9fa';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('fileInput').files = files;
                    handleFileSelect(files[0]);
                }
            });

            document.getElementById('fileInput').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        }

        function handleFileSelect(file) {
            if (file.type !== 'application/json') {
                showAlert('error', 'Vui lòng chọn file JSON hợp lệ!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('jsonInput').value = e.target.result;
                showAlert('success', `Đã tải file: ${file.name}`);
            };
            reader.readAsText(file);
        }

        function loadData() {
            const jsonInput = document.getElementById('jsonInput').value.trim();

            if (!jsonInput) {
                showAlert('error', 'Vui lòng nhập hoặc tải dữ liệu JSON!');
                return;
            }

            try {
                const data = JSON.parse(jsonInput);
                
                // Ensure data is array
                const questions = Array.isArray(data) ? data : [data];

                // Validate question format
                if (!validateData(questions)) {
                    return;
                }

                generatedQuestions = questions.map((q, i) => ({
                    id: q.id || i + 1,
                    type: q.type || "Choice",
                    question: q.question,
                    choices: q.choices,
                    choicesVi: q.choicesVi || {},
                    correctAnswer: q.correctAnswer || "A",
                    typeAnswer: q.typeAnswer || "choice",
                    explanation: q.explanation || "",
                    tips: q.tips || "",
                    voiceAssignment: {
                        question: Math.random() > 0.5 ? "male" : "female",
                        responses: null
                    }
                }));

                // Ensure responses voice is different from question voice
                generatedQuestions.forEach(q => {
                    q.voiceAssignment.responses = q.voiceAssignment.question === 'male' ? 'female' : 'male';
                });

                generatedAudio = new Array(generatedQuestions.length).fill(null);
                totalQuestions = generatedQuestions.length;
                audioGenerated = 0;
                cloudinaryUploads = 0;

                updateStats();
                displayQuestionsPreview();
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('questionsContainer').style.display = 'block';
                showAlert('success', `Đã tải thành công ${totalQuestions} câu hỏi!`);
                
            } catch (error) {
                showAlert('error', 'Dữ liệu JSON không hợp lệ: ' + error.message);
            }
        }

        function validateData(data) {
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                if (!item.question || !item.choices) {
                    showAlert('error', `Dữ liệu không hợp lệ tại item ${i + 1}: thiếu question hoặc choices`);
                    return false;
                }
            }
            return true;
        }

        function displayQuestionsPreview() {
            const preview = document.getElementById('questionsPreview');
            preview.innerHTML = '';

            generatedQuestions.forEach((question, index) => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card';
                
                const voiceInfo = `Question: ${question.voiceAssignment.question} | Responses: ${question.voiceAssignment.responses}`;
                
                questionCard.innerHTML = `
                    <div class="question-header">
                        <span class="question-number">${question.id}</span>
                        <span class="voice-indicator"><i class="fas fa-microphone"></i> ${voiceInfo}</span>
                    </div>
                    <div class="question-text">${question.question}</div>
                    <div class="choices-container">
                        ${Object.entries(question.choices).map(([key, value]) => `
                            <div class="choice-item ${key === question.correctAnswer ? 'correct' : ''}">
                                <span class="choice-label">${key}</span>
                                <span>${value}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="audio-controls">
                        <audio class="audio-player" id="audio-${index}" controls style="display: none;">
                            <source type="audio/mpeg">
                            Trình duyệt không hỗ trợ audio.
                        </audio>
                        <div class="audio-buttons">
                            <button class="btn" onclick="generateSingleAudio(${index})" id="btn-${index}">
                                <i class="fas fa-play"></i> Tạo Audio
                            </button>
                            <button class="btn btn-secondary" onclick="downloadSingle(${index})" id="download-${index}" disabled>
                                <i class="fas fa-download"></i> Tải JSON
                            </button>
                        </div>
                    </div>
                    
                    ${question.explanation ? `
                        <div class="question-info">
                            <strong>Giải thích:</strong> ${question.explanation}
                            ${question.tips ? `<br><strong>Tips:</strong> ${question.tips}` : ''}
                        </div>
                    ` : ''}
                `;
                
                preview.appendChild(questionCard);
            });
        }

        function updateProgress(percent, message) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressFill.textContent = Math.round(percent) + '%';
            progressText.textContent = message;
        }

        function updateStats() {
            document.getElementById('totalQuestions').textContent = totalQuestions;
            document.getElementById('audioGenerated').textContent = audioGenerated;
            document.getElementById('cloudinaryUploads').textContent = cloudinaryUploads;
            
            const successRate = totalQuestions > 0 ? Math.round((cloudinaryUploads / totalQuestions) * 100) : 0;
            document.getElementById('successRate').textContent = successRate + '%';
        }

        // Convert base64 to Blob
        function base64ToBlob(base64Data, contentType = 'audio/mp3') {
            const base64 = base64Data.split(',')[1];
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: contentType });
        }

        async function uploadAudioToCloudinary(base64Audio, filename) {
            try {
                // Convert base64 to blob
                const audioBlob = base64ToBlob(base64Audio);
                
                const formData = new FormData();
                formData.append('file', audioBlob, filename);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('folder', 'toeic_part2');
                formData.append('resource_type', 'auto');

                const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                if (result.secure_url) {
                    cloudinaryUploads++;
                    updateStats();
                    return result.secure_url;
                } else {
                    throw new Error(result.error?.message || 'Không nhận được URL từ Cloudinary');
                }
            } catch (error) {
                console.error('❌ Lỗi upload Cloudinary:', error);
                return null;
            }
        }

        async function generateAudio() {
            updateProgress(10, "Đang bắt đầu tạo audio...");
            try {
                if (!generatedQuestions.length) {
                    showAlert('error', 'Vui lòng tải file JSON trước!');
                    return;
                }

                console.log("✅ Starting audio generation for", generatedQuestions.length, "questions");
                updateProgress(20, "Đang tạo audio với Google TTS...");
                generatedAudio = [];
                audioGenerated = 0;
                cloudinaryUploads = 0;

                for (let i = 0; i < generatedQuestions.length; i++) {
                    try {
                        updateProgress(20 + (i * 70 / generatedQuestions.length), `Tạo audio ${i + 1}/${generatedQuestions.length}...`);

                        const question = generatedQuestions[i];
                        const voiceConfig = question.voiceAssignment;

                        // Voice configuration for TOEIC Part 2
                        const alternateVoices = {
                            male: ['en-US-Standard-B', 'en-US-Standard-D'],
                            female: ['en-US-Standard-C', 'en-US-Standard-E']
                        };

                        // Select voices with variety
                        const questionVoice = voiceConfig.question === 'female' ? 
                            alternateVoices.female[i % 2] : alternateVoices.male[i % 2];
                        const responseVoice = voiceConfig.responses === 'female' ? 
                            alternateVoices.female[(i + 1) % 2] : alternateVoices.male[(i + 1) % 2];

                        // Text content
                        const questionText = question.question;
                        const responseA = question.choices.A;
                        const responseB = question.choices.B;
                        const responseC = question.choices.C;

                        // SSML content with TOEIC-like timing
                        const ssmlContent = `
                            <speak>
                                <voice name="en-US-Standard-B">
                                    <prosody rate="0.9" pitch="0st">
                                        Number ${i + 1}.
                                        <break time="1.0s"/>
                                    </prosody>
                                </voice>
                                
                                <voice name="${questionVoice}">
                                    <prosody rate="0.85" pitch="0st">
                                        ${questionText}
                                    </prosody>
                                </voice>

                                <break time="1.5s"/>

                                <voice name="${responseVoice}">
                                    <prosody rate="0.9" pitch="0st">
                                        <emphasis level="moderate">A.</emphasis>
                                        <break time="0.3s"/>
                                        ${responseA}
                                    </prosody>
                                </voice>

                                <break time="1.0s"/>

                                <voice name="${responseVoice}">
                                    <prosody rate="0.9" pitch="0st">
                                        <emphasis level="moderate">B.</emphasis>
                                        <break time="0.3s"/>
                                        ${responseB}
                                    </prosody>
                                </voice>

                                <break time="1.0s"/>

                                <voice name="${responseVoice}">
                                    <prosody rate="0.9" pitch="0st">
                                        <emphasis level="moderate">C.</emphasis>
                                        <break time="0.3s"/>
                                        ${responseC}
                                    </prosody>
                                </voice>
                            </speak>
                        `;

                        // Generate audio with Google TTS
                        const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                input: { ssml: ssmlContent },
                                voice: {
                                    languageCode: 'en-US'
                                },
                                audioConfig: {
                                    audioEncoding: 'MP3',
                                    speakingRate: 0.85,
                                    pitch: 0.0,
                                    volumeGainDb: 0.0,
                                    effectsProfileId: ['headphone-class-device']
                                }
                            })
                        });

                        const result = await response.json();

                        if (result.audioContent) {
                            const base64Audio = `data:audio/mp3;base64,${result.audioContent}`;
                            audioGenerated++;
                            
                            // Upload to Cloudinary
                            updateProgress(20 + (i * 70 / generatedQuestions.length), `Upload audio ${i + 1}/${generatedQuestions.length} lên Cloudinary...`);
                            const filename = `toeic_part2_question_${i + 1}_${Date.now()}.mp3`;
                            const cloudinaryUrl = await uploadAudioToCloudinary(base64Audio, filename);
                            
                            if (cloudinaryUrl) {
                                generatedAudio.push(cloudinaryUrl);
                                console.log(`✅ Upload audio câu ${i + 1} thành công:`, cloudinaryUrl);
                            } else {
                                generatedAudio.push(null);
                                console.warn(`⚠️ Upload audio câu ${i + 1} thất bại`);
                            }
                        } else {
                            console.error(`❌ Không tạo được audio cho câu hỏi ${i + 1}:`, result);
                            generatedAudio.push(null);
                        }

                        updateStats();
                        await new Promise(resolve => setTimeout(resolve, 300)); // Rate limit delay
                    } catch (error) {
                        console.error(`❌ Lỗi khi tạo audio câu ${i + 1}:`, error);
                        generatedAudio.push(null);
                    }
                }

                updateProgress(100, "Tạo audio hoàn tất!");
                displayQuestionsPreview();
                document.getElementById('downloadAllBtn').disabled = false;
                showAlert('success', `Đã tạo thành công ${audioGenerated}/${totalQuestions} audio files!`);
                
                return true;
            } catch (error) {
                console.error("❌ Error in generateAudio:", error);
                updateProgress(0, `Lỗi khi tạo audio: ${error.message}`);
                showAlert('error', `Lỗi khi tạo audio: ${error.message}`);
                return false;
            }
        }

        function downloadGeneratedData() {
            if (!generatedQuestions.length || !generatedAudio.length) {
                showAlert('error', 'Chưa có dữ liệu để download!');
                return;
            }

            const finalData = generatedQuestions.map((question, index) => ({
                id: question.id,
                type: question.type,
                question: question.question,
                choices: question.choices,
                choicesVi: question.choicesVi,
                correctAnswer: question.correctAnswer,
                typeAnswer: question.typeAnswer,
                explanation: question.explanation,
                tips: question.tips,
                audio: generatedAudio[index] || null,
                voiceAssignment: question.voiceAssignment
            }));

            const blob = new Blob([JSON.stringify(finalData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `toeic_part2_with_audio_${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showAlert('success', 'File JSON đã được tải xuống thành công!');
        }



        // Generate audio for single question
        async function generateSingleAudio(index) {
            const btn = document.getElementById(`btn-${index}`);
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang tạo...';

            try {
                const question = generatedQuestions[index];
                const voiceConfig = question.voiceAssignment;

                // Voice configuration for TOEIC Part 2
                const alternateVoices = {
                    male: ['en-US-Standard-B', 'en-US-Standard-D'],
                    female: ['en-US-Standard-C', 'en-US-Standard-E']
                };

                // Select voices with variety
                const questionVoice = voiceConfig.question === 'female' ? 
                    alternateVoices.female[index % 2] : alternateVoices.male[index % 2];
                const responseVoice = voiceConfig.responses === 'female' ? 
                    alternateVoices.female[(index + 1) % 2] : alternateVoices.male[(index + 1) % 2];

                // Text content
                const questionText = question.question;
                const responseA = question.choices.A;
                const responseB = question.choices.B;
                const responseC = question.choices.C;

                // SSML content with TOEIC-like timing
                const ssmlContent = `
                    <speak>
                        <voice name="en-US-Standard-B">
                            <prosody rate="0.9" pitch="0st">
                                Number ${index + 1}.
                                <break time="1.0s"/>
                            </prosody>
                        </voice>
                        
                        <voice name="${questionVoice}">
                            <prosody rate="0.85" pitch="0st">
                                ${questionText}
                            </prosody>
                        </voice>

                        <break time="1.5s"/>

                        <voice name="${responseVoice}">
                            <prosody rate="0.9" pitch="0st">
                                <emphasis level="moderate">A.</emphasis>
                                <break time="0.3s"/>
                                ${responseA}
                            </prosody>
                        </voice>

                        <break time="1.0s"/>

                        <voice name="${responseVoice}">
                            <prosody rate="0.9" pitch="0st">
                                <emphasis level="moderate">B.</emphasis>
                                <break time="0.3s"/>
                                ${responseB}
                            </prosody>
                        </voice>

                        <break time="1.0s"/>

                        <voice name="${responseVoice}">
                            <prosody rate="0.9" pitch="0st">
                                <emphasis level="moderate">C.</emphasis>
                                <break time="0.3s"/>
                                ${responseC}
                            </prosody>
                        </voice>
                    </speak>
                `;

                // Generate audio with Google TTS
                const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        input: { ssml: ssmlContent },
                        voice: {
                            languageCode: 'en-US'
                        },
                        audioConfig: {
                            audioEncoding: 'MP3',
                            speakingRate: 0.9,
                            pitch: 0.0,
                            volumeGainDb: 0.0,
                            effectsProfileId: ['headphone-class-device']
                        }
                    })
                });

                const result = await response.json();

                if (result.audioContent) {
                    const audioData = `data:audio/mp3;base64,${result.audioContent}`;
                    generatedAudio[index] = audioData;
                    updateAudioPlayer(index, audioData);
                    
                    if (generatedAudio.filter(a => a !== null).length > audioGenerated) {
                        audioGenerated++;
                    }
                    
                    updateStats();
                    btn.innerHTML = '<i class="fas fa-check"></i> Đã tạo';
                    btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    document.getElementById(`download-${index}`).disabled = false;
                    showAlert('success', `Tạo audio thành công cho câu ${index + 1}!`);
                } else {
                    throw new Error(result.error?.message || 'Unknown error');
                }

            } catch (error) {
                showAlert('error', `Lỗi khi tạo audio: ${error.message}`);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Lỗi';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            btn.disabled = false;
        }

        // Update audio player for single question
        function updateAudioPlayer(index, audioData) {
            const audioPlayer = document.getElementById(`audio-${index}`);
            
            if (audioPlayer) {
                audioPlayer.src = audioData;
                audioPlayer.style.display = 'block';
            }
        }

        // Download single question JSON with Cloudinary URL
        async function downloadSingle(index) {
            const downloadBtn = document.getElementById(`download-${index}`);
            
            if (!generatedAudio[index]) {
                showAlert('error', 'Chưa có audio cho câu này!');
                return;
            }

            // Disable button and show loading
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';

            try {
                // Upload to Cloudinary first
                showAlert('info', `Đang upload audio câu ${index + 1} lên Cloudinary...`);
                const filename = `toeic_part2_question_${index + 1}_${Date.now()}.mp3`;
                const cloudinaryUrl = await uploadAudioToCloudinary(generatedAudio[index], filename);
                
                if (!cloudinaryUrl) {
                    throw new Error('Upload Cloudinary thất bại');
                }

                const question = generatedQuestions[index];
                
                // Create JSON according to required format
                const jsonItem = {
                    id: question.id,
                    type: question.type,
                    question: question.question,
                    choices: question.choices,
                    choicesVi: question.choicesVi,
                    correctAnswer: question.correctAnswer,
                    typeAnswer: question.typeAnswer,
                    explanation: question.explanation,
                    tips: question.tips,
                    audio: cloudinaryUrl,
                    voiceAssignment: question.voiceAssignment
                };

                // Create and download JSON file
                const jsonString = JSON.stringify(jsonItem, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `toeic_part2_question_${index + 1}_${Date.now()}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                downloadBtn.innerHTML = '<i class="fas fa-check"></i> Đã tải JSON';
                downloadBtn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                
                // Update cloudinary count
                cloudinaryUploads++;
                updateStats();
                
                showAlert('success', `Đã tải JSON cho câu ${index + 1} với audio Cloudinary!`);
                
            } catch (error) {
                showAlert('error', `Lỗi khi xử lý câu ${index + 1}: ${error.message}`);
                downloadBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Lỗi';
                downloadBtn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            downloadBtn.disabled = false;
        }

        function clearAllAudio() {
            if (confirm('Bạn có chắc muốn xóa tất cả audio đã tạo?')) {
                generatedAudio = new Array(generatedQuestions.length).fill(null);
                audioGenerated = 0;
                cloudinaryUploads = 0;
                
                // Reset all audio players and buttons
                for (let i = 0; i < generatedQuestions.length; i++) {
                    const audioPlayer = document.getElementById(`audio-${i}`);
                    const downloadBtn = document.getElementById(`download-${i}`);
                    const generateBtn = document.getElementById(`btn-${i}`);
                    
                    if (audioPlayer) {
                        audioPlayer.style.display = 'none';
                        audioPlayer.src = '';
                    }
                    if (downloadBtn) {
                        downloadBtn.disabled = true;
                        downloadBtn.innerHTML = '<i class="fas fa-download"></i> Tải JSON';
                        downloadBtn.style.background = 'linear-gradient(45deg, #6c757d, #495057)';
                    }
                    if (generateBtn) {
                        generateBtn.innerHTML = '<i class="fas fa-play"></i> Tạo Audio';
                        generateBtn.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
                        generateBtn.disabled = false;
                    }
                }
                
                updateStats();
                document.getElementById('downloadAllBtn').disabled = true;
                document.getElementById('generateBtn').disabled = false;
                
                showAlert('success', 'Đã xóa tất cả audio!');
            }
        }

        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            let alertClass, icon;
            
            switch(type) {
                case 'error':
                    alertClass = 'alert-error';
                    icon = 'exclamation-triangle';
                    break;
                case 'success':
                    alertClass = 'alert-success';
                    icon = 'check-circle';
                    break;
                case 'info':
                    alertClass = 'alert-info';
                    icon = 'info-circle';
                    break;
                default:
                    alertClass = 'alert-info';
                    icon = 'info-circle';
            }
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.innerHTML = `
                <i class="fas fa-${icon}"></i>
                ${message}
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Tab switching functionality
        function switchTab(tabType) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            if (tabType === 'file') {
                document.getElementById('fileTab').classList.add('active');
                document.getElementById('fileUploadTab').classList.add('active');
            } else if (tabType === 'paste') {
                document.getElementById('pasteTab').classList.add('active');
                document.getElementById('pasteJsonTab').classList.add('active');
            }
        }

        // Clear data
        function clearData() {
            if (confirm('Bạn có chắc muốn xóa tất cả dữ liệu?')) {
                generatedQuestions = [];
                generatedAudio = [];
                totalQuestions = 0;
                audioGenerated = 0;
                cloudinaryUploads = 0;
                
                document.getElementById('jsonInput').value = '';
                document.getElementById('fileInput').value = '';
                document.getElementById('questionsContainer').style.display = 'none';
                document.getElementById('alertContainer').innerHTML = '';
                
                updateStats();
                showAlert('success', 'Đã xóa tất cả dữ liệu!');
            }
        }
    </script>
</body>
</html>