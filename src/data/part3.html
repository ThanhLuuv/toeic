<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOEIC Part 3 - Audio Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
            margin-bottom: 30px;
        }

        .input-section {
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            width: 100%;
            transition: all 0.3s;
        }

        .file-input-wrapper:hover {
            background: #e9ecef;
            border-color: #495057;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #e83e8c);
        }

        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-weight: 600;
            color: #555;
        }

        .conversations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .conversation-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .conversation-title {
            font-weight: 600;
            color: #333;
        }

        .conversation-level {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .audio-script {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #e1e5e9;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            max-height: 200px;
            overflow-y: auto;
        }

        .audio-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .audio-player {
            width: 100%;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
        }

        .audio-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .questions-summary {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e1e5e9;
        }

        .question-item {
            margin-bottom: 8px;
            font-size: 13px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.8;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .conversations-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
            
            .audio-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .audio-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-headphones"></i> TOEIC Part 3 Audio Generator</h1>
        </div>

        <div class="stats" id="statsContainer" style="display: none;">
            <div class="stat-card">
                <div class="stat-number" id="totalConversations">0</div>
                <div class="stat-label">ƒêo·∫°n h·ªôi tho·∫°i</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalQuestions">0</div>
                <div class="stat-label">C√¢u h·ªèi</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="audioGenerated">0</div>
                <div class="stat-label">Audio h·ªôi tho·∫°i</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uploadedToCloudinary">0</div>
                <div class="stat-label">Upload Cloudinary</div>
            </div>
        </div>

        <div class="card">
            <div class="input-section">
                <h2><i class="fas fa-upload"></i> T·∫£i d·ªØ li·ªáu</h2>
                


                <div class="input-group">
                    <label>T·∫£i d·ªØ li·ªáu JSON</label>
                    <div class="file-input-wrapper">
                        <input type="file" id="jsonFile" accept=".json">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2em; color: #667eea; margin-bottom: 10px;"></i>
                        <div>Ch·ªçn file JSON ho·∫∑c k√©o th·∫£ v√†o ƒë√¢y</div>
                        <small style="color: #6c757d;">H·ªó tr·ª£ file .json</small>
                    </div>
                </div>

                <div class="input-group">
                    <label for="jsonInput">Ho·∫∑c d√°n JSON tr·ª±c ti·∫øp</label>
                    <textarea id="jsonInput" rows="8" placeholder="D√°n n·ªôi dung JSON v√†o ƒë√¢y..."></textarea>
                </div>

                <div>
                    <button class="btn" onclick="loadData()">
                        <i class="fas fa-upload"></i> T·∫£i d·ªØ li·ªáu
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()">
                        <i class="fas fa-trash"></i> X√≥a d·ªØ li·ªáu
                    </button>
                </div>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">ƒêang x·ª≠ l√Ω...</div>
            </div>

            <div id="alertContainer"></div>
        </div>

        <div class="card" id="conversationsContainer" style="display: none;">
            <div style="display: flex; justify-content: space-between; flex-direction: column;align-items: center; margin-bottom: 20px;">
                <h2><i class="fas fa-comments"></i> Danh s√°ch ƒëo·∫°n h·ªôi tho·∫°i</h2>
                <div>
                    <button class="btn btn-success" onclick="generateAllAudio()" id="generateAllBtn">
                        <i class="fas fa-play"></i> T·∫°o t·∫•t c·∫£ Audio (H·ªôi tho·∫°i + C√¢u h·ªèi)
                    </button>
                    <button class="btn btn-secondary" onclick="downloadAllAudio()" id="downloadAllBtn" disabled>
                        <i class="fas fa-download"></i> T·∫£i MP3 t·∫•t c·∫£
                    </button>
                    <button class="btn btn-danger" onclick="clearAllAudio()" id="clearAudioBtn">
                        <i class="fas fa-trash"></i> X√≥a t·∫•t c·∫£ Audio
                    </button>
                </div>
                
                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e1e5e9;">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Batch Processing - Upload t·∫•t c·∫£ l√™n Cloudinary</h3>
                    <p style="color: #6c757d; margin-bottom: 15px;">
                        <small>üí° ƒê·ªÉ x·ª≠ l√Ω h√†ng lo·∫°t: Upload t·∫•t c·∫£ audio l√™n Cloudinary v√† t·∫°o m·ªôt file JSON ch·ª©a t·∫•t c·∫£ items<br>
                        üìå Kh√°c bi·ªát: N√∫t "T·∫£i JSON" ·ªü m·ªói ƒëo·∫°n s·∫Ω t·ª± ƒë·ªông upload + t·∫°o JSON cho t·ª´ng item ri√™ng l·∫ª</small>
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="uploadAllAudioToCloudinary()" id="uploadCloudinaryBtn" disabled>
                            <i class="fas fa-cloud-upload-alt"></i> Batch Upload t·∫•t c·∫£ l√™n Cloudinary
                        </button>
                        <button class="btn btn-success" onclick="downloadJsonWithCloudinaryUrls()" id="downloadJsonBtn" disabled>
                            <i class="fas fa-download"></i> T·∫£i JSON Array (t·∫•t c·∫£ items)
                        </button>
                    </div>
                </div>
            </div>
            </div>
            
            <div class="conversations-grid" id="conversationsList"></div>
        </div>
    </div>

    <script>
        // Bi·∫øn to√†n c·ª•c
        let GOOGLE_TTS_KEY = 'AIzaSyAqO6_hgidkr_qandEMZUJlBcAhF3xOsUk';
        let generatedConversations = [];
        let generatedAudio = [];
        let cloudinaryAudioUrls = [];
        let audioGeneratedCount = 0;
        let uploadedToCloudinaryCount = 0;

        // Cloudinary config
        const CLOUDINARY_UPLOAD_URL = 'https://api.cloudinary.com/v1_1/dlysxsbkj/auto/upload';
        const CLOUDINARY_UPLOAD_PRESET = 'toeic_part3';

        // Kh·ªüi t·∫°o
        document.addEventListener('DOMContentLoaded', function() {
            // X·ª≠ l√Ω drag & drop
            const fileWrapper = document.querySelector('.file-input-wrapper');
            
            fileWrapper.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = '#495057';
                this.style.background = '#e9ecef';
            });
            
            fileWrapper.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.style.borderColor = '#667eea';
                this.style.background = '#f8f9fa';
            });
            
            fileWrapper.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = '#667eea';
                this.style.background = '#f8f9fa';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    document.getElementById('jsonFile').files = files;
                    handleFileSelect(files[0]);
                }
            });

            // X·ª≠ l√Ω ch·ªçn file
            document.getElementById('jsonFile').addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });
        });

        // X·ª≠ l√Ω file ƒë∆∞·ª£c ch·ªçn
        function handleFileSelect(file) {
            if (file.type !== 'application/json') {
                showAlert('error', 'Vui l√≤ng ch·ªçn file JSON h·ª£p l·ªá!');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('jsonInput').value = e.target.result;
                showAlert('success', `ƒê√£ t·∫£i file: ${file.name}`);
            };
            reader.readAsText(file);
        }

        // T·∫£i v√† x·ª≠ l√Ω d·ªØ li·ªáu
        function loadData() {
            const jsonInput = document.getElementById('jsonInput').value.trim();

            if (!jsonInput) {
                showAlert('error', 'Vui l√≤ng nh·∫≠p ho·∫∑c t·∫£i d·ªØ li·ªáu JSON!');
                return;
            }

            try {
                const data = JSON.parse(jsonInput);
                
                // Ki·ªÉm tra d·ªØ li·ªáu c√≥ ph·∫£i l√† array kh√¥ng
                if (Array.isArray(data)) {
                    generatedConversations = data;
                } else {
                    generatedConversations = [data];
                }

                // Validate d·ªØ li·ªáu
                if (!validateData(generatedConversations)) {
                    return;
                }

                generatedAudio = new Array(generatedConversations.length).fill(null);
                cloudinaryAudioUrls = new Array(generatedConversations.length).fill(null);
                audioGeneratedCount = 0;
                uploadedToCloudinaryCount = 0;

                displayConversations();
                updateStats();
                showAlert('success', `ƒê√£ t·∫£i th√†nh c√¥ng ${generatedConversations.length} ƒëo·∫°n h·ªôi tho·∫°i! üéµ T·∫°o Audio ‚Üí üìÑ T·∫£i JSON (t·ª± ƒë·ªông upload Cloudinary + t·∫°o JSON v·ªõi audio URL)`);
                
            } catch (error) {
                showAlert('error', 'D·ªØ li·ªáu JSON kh√¥ng h·ª£p l·ªá: ' + error.message);
            }
        }

        // Validate d·ªØ li·ªáu
        function validateData(data) {
            for (let i = 0; i < data.length; i++) {
                const item = data[i];
                if (!item.audioScript || !item.questions) {
                    showAlert('error', `D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá t·∫°i item ${i + 1}: thi·∫øu audioScript ho·∫∑c questions`);
                    return false;
                }
            }
            return true;
        }

        // Hi·ªÉn th·ªã danh s√°ch ƒëo·∫°n h·ªôi tho·∫°i
        function displayConversations() {
            const container = document.getElementById('conversationsList');
            container.innerHTML = '';

            generatedConversations.forEach((conv, index) => {
                const card = createConversationCard(conv, index);
                container.appendChild(card);
            });

            document.getElementById('conversationsContainer').style.display = 'block';
            document.getElementById('statsContainer').style.display = 'grid';
        }

        // T·∫°o card ƒëo·∫°n h·ªôi tho·∫°i
        function createConversationCard(conv, index) {
            const card = document.createElement('div');
            card.className = 'conversation-card';
            card.innerHTML = `
                <div class="conversation-header">
                    <div class="conversation-title">ƒêo·∫°n ${index + 1} ${conv.id ? `(ID: ${conv.id})` : ''}</div>
                    <div class="conversation-level">${conv.level || 'N/A'}</div>
                </div>
                
                <div class="audio-script">${formatAudioScript(conv.audioScript)}</div>
                
                <div class="audio-controls">
                    <audio class="audio-player" id="audio-${index}" controls style="display: none;">
                        <source type="audio/mpeg">
                        Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.
                    </audio>
                    <div class="audio-buttons">
                        <button class="btn" onclick="generateSingleAudio(${index})" id="btn-${index}">
                            <i class="fas fa-play"></i> T·∫°o Audio (H·ªôi tho·∫°i + C√¢u h·ªèi)
                        </button>
                        <button class="btn btn-secondary" onclick="downloadSingleAudio(${index})" id="download-${index}" disabled>
                            <i class="fas fa-download"></i> T·∫£i JSON
                        </button>
                    </div>
                </div>
                
                <div class="questions-summary">
                    <strong>C√¢u h·ªèi (${conv.questions.length}):</strong>
                    ${conv.questions.map((q, i) => `
                        <div class="question-item">
                            <strong>Q${i + 1}:</strong> ${q.question.substring(0, 80)}${q.question.length > 80 ? '...' : ''}
                        </div>
                    `).join('')}
                    <hr style="margin: 10px 0; border: none; border-top: 1px solid #e1e5e9;">
                    
                </div>
            `;
            return card;
        }

        // Format audio script cho hi·ªÉn th·ªã
        function formatAudioScript(script) {
            return script.split('\n').map(line => {
                if (line.match(/^([A-Z0-9]+):\s(.+)$/)) {
                    const [, speaker, text] = line.match(/^([A-Z0-9]+):\s(.+)$/);
                    return `<strong style="color: #667eea;">${speaker}:</strong> ${text}`;
                }
                return line;
            }).join('<br>');
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStats() {
            document.getElementById('totalConversations').textContent = generatedConversations.length;
            document.getElementById('totalQuestions').textContent = 
                generatedConversations.reduce((sum, conv) => sum + conv.questions.length, 0);
            document.getElementById('audioGenerated').textContent = audioGeneratedCount;
            document.getElementById('uploadedToCloudinary').textContent = uploadedToCloudinaryCount;
        }

        // C·∫≠p nh·∫≠t progress
        function updateProgress(percent, message) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressText.textContent = message;
            
            if (percent >= 100) {
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                }, 2000);
            }
        }

        // H√†m t·∫°o audio cho Part 3 (t·ª´ ng∆∞·ªùi d√πng)
        async function generateAudioForPart3() {
            updateProgress(55, "ƒêang t·∫°o audio cho c√°c ƒëo·∫°n h·ªôi tho·∫°i Part 3...");
            generatedAudio = [];

            for (let i = 0; i < generatedConversations.length; i++) {
                try {
                    updateProgress(55 + (i * 3), `T·∫°o audio ƒëo·∫°n ${i + 1}/${generatedConversations.length}...`);

                    const conv = generatedConversations[i];
                    const lines = conv.audioScript.split("\n");

                    // Mapping nh√¢n v·∫≠t -> voice
                    const voiceMap = {
                        "M": "en-US-Wavenet-D",  // Nam
                        "M1": "en-US-Wavenet-D",
                        "M2": "en-US-Wavenet-B", // Nam ph·ª• kh√°c gi·ªçng
                        "W": "en-US-Wavenet-F",  // N·ªØ
                        "W1": "en-US-Wavenet-F",
                        "W2": "en-US-Wavenet-E"
                    };

                    // T·∫°o SSML script cho ƒëo·∫°n h·ªôi tho·∫°i
                    let ssmlContent = `<speak><prosody rate="slow">Conversation ${i + 1}.</prosody><break time="1s"/>`;

                    for (const line of lines) {
                        const match = line.match(/^([A-Z0-9]+):\s(.+)$/);
                        if (!match) continue;

                        const speaker = match[1];
                        const text = match[2];
                        const voice = voiceMap[speaker] || "en-US-Wavenet-D";

                        // Ch√®n break sau m·ªói c√¢u nh·ªè trong m·ªôt c√¢u tho·∫°i
                        const sentences = text.split(/([.?!])/).reduce((acc, cur, idx, arr) => {
                            if (cur.match(/[.?!]/) && idx > 0) {
                                acc[acc.length - 1] += cur;
                            } else if (cur.trim() !== '') {
                                acc.push(cur);
                            }
                            return acc;
                        }, []);
                        const textWithBreaks = sentences.map(s => s.trim() ? `${s.trim()}<break time="0.5s"/>` : '').join(' ');

                        ssmlContent += `<voice name="${voice}"><prosody rate="medium">${textWithBreaks}</prosody></voice>`;
                        ssmlContent += `<break time="1.2s"/>`;
                    }

                    // Th√™m ph·∫ßn ƒë·ªçc c√¢u h·ªèi
                    ssmlContent += `<break time="4s"/><voice name="en-US-Wavenet-D"><prosody rate="medium">Now you will hear three questions about the conversation.</prosody></voice><break time="2s"/>`;
                    
                    conv.questions.forEach((question, qIndex) => {
                        // ƒê·ªçc s·ªë c√¢u h·ªèi v·ªõi gi·ªçng c·ªë ƒë·ªãnh
                        ssmlContent += `<voice name="en-US-Wavenet-D"><prosody rate="medium">Question ${qIndex + 1}.</prosody></voice>`;
                        ssmlContent += `<break time="1.2s"/>`;
                        
                        // ƒê·ªçc c√¢u h·ªèi v·ªõi gi·ªçng c·ªë ƒë·ªãnh
                        ssmlContent += `<voice name="en-US-Wavenet-D"><prosody rate="medium">${question.question}</prosody></voice>`;
                        
                        // Ngh·ªâ 4 gi√¢y gi·ªØa c√°c c√¢u h·ªèi
                        if (qIndex < conv.questions.length - 1) {
                            ssmlContent += `<break time="4s"/>`;
                        } else {
                            ssmlContent += `<break time="2s"/>`;
                        }
                    });

                    ssmlContent += `</speak>`;

                    const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            input: { ssml: ssmlContent },
                            voice: { languageCode: 'en-US' },
                            audioConfig: {
                                audioEncoding: 'MP3',
                                speakingRate: 0.85,
                                pitch: 0.0
                            }
                        })
                    });

                    const result = await response.json();

                    if (result.audioContent) {
                        generatedAudio.push(`data:audio/mp3;base64,${result.audioContent}`);
                        audioGeneratedCount++;
                        updateAudioPlayer(i, `data:audio/mp3;base64,${result.audioContent}`);
                    } else {
                        console.error(`‚ùå Kh√¥ng t·∫°o ƒë∆∞·ª£c audio cho ƒëo·∫°n ${i + 1}:`, result);
                        generatedAudio.push(null);
                        showAlert('error', `Kh√¥ng t·∫°o ƒë∆∞·ª£c audio cho ƒëo·∫°n ${i + 1}: ${result.error?.message || 'Unknown error'}`);
                    }

                    await new Promise(resolve => setTimeout(resolve, 200));
                } catch (error) {
                    console.error(`‚ùå L·ªói khi t·∫°o audio ƒëo·∫°n ${i + 1}:`, error);
                    generatedAudio.push(null);
                    showAlert('error', `L·ªói khi t·∫°o audio ƒëo·∫°n ${i + 1}: ${error.message}`);
                }
            }

            updateProgress(100, "Ho√†n t·∫•t t·∫°o audio Part 3! S·∫µn s√†ng luy·ªán nghe. (H·ªôi tho·∫°i + C√¢u h·ªèi, kh√¥ng bao g·ªìm ƒë√°p √°n)");
            updateStats();
            document.getElementById('downloadAllBtn').disabled = audioGeneratedCount === 0;
            document.getElementById('uploadCloudinaryBtn').disabled = audioGeneratedCount === 0;
            return true;
        }

        // T·∫°o audio cho m·ªôt ƒëo·∫°n c·ª• th·ªÉ
        async function generateSingleAudio(index) {
            const btn = document.getElementById(`btn-${index}`);
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';

            try {
                const conv = generatedConversations[index];
                const lines = conv.audioScript.split("\n");

                const voiceMap = {
                    "M": "en-US-Wavenet-D",
                    "M1": "en-US-Wavenet-D",
                    "M2": "en-US-Wavenet-B",
                    "W": "en-US-Wavenet-F",
                    "W1": "en-US-Wavenet-F",
                    "W2": "en-US-Wavenet-E"
                };

                let ssmlContent = `<speak><prosody rate="slow">Conversation ${index + 1}.</prosody><break time="1s"/>`;

                for (const line of lines) {
                    const match = line.match(/^([A-Z0-9]+):\s(.+)$/);
                    if (!match) continue;

                    const speaker = match[1];
                    const text = match[2];
                    const voice = voiceMap[speaker] || "en-US-Wavenet-D";

                    // Ch√®n break sau m·ªói c√¢u nh·ªè trong m·ªôt c√¢u tho·∫°i
                    const sentences = text.split(/([.?!])/).reduce((acc, cur, idx, arr) => {
                        if (cur.match(/[.?!]/) && idx > 0) {
                            acc[acc.length - 1] += cur;
                        } else if (cur.trim() !== '') {
                            acc.push(cur);
                        }
                        return acc;
                    }, []);
                    const textWithBreaks = sentences.map(s => s.trim() ? `${s.trim()}<break time="0.7s"/>` : '').join(' ');

                    ssmlContent += `<voice name="${voice}"><prosody rate="medium">${textWithBreaks}</prosody></voice>`;
                    ssmlContent += `<break time="1.2s"/>`;
                }

                // Th√™m ph·∫ßn ƒë·ªçc c√¢u h·ªèi
                ssmlContent += `<break time="4s"/><voice name="en-US-Wavenet-D"><prosody rate="medium">Now you will hear three questions about the conversation.</prosody></voice><break time="2s"/>`;
                
                conv.questions.forEach((question, qIndex) => {
                    // ƒê·ªçc s·ªë c√¢u h·ªèi v·ªõi gi·ªçng c·ªë ƒë·ªãnh
                    ssmlContent += `<voice name="en-US-Wavenet-D"><prosody rate="medium">Question ${qIndex + 1}.</prosody></voice>`;
                    ssmlContent += `<break time="1.2s"/>`;
                    
                    // ƒê·ªçc c√¢u h·ªèi v·ªõi gi·ªçng c·ªë ƒë·ªãnh
                    ssmlContent += `<voice name="en-US-Wavenet-D"><prosody rate="medium">${question.question}</prosody></voice>`;
                    
                    // Ngh·ªâ 4 gi√¢y gi·ªØa c√°c c√¢u h·ªèi
                    if (qIndex < conv.questions.length - 1) {
                        ssmlContent += `<break time="4s"/>`;
                    } else {
                        ssmlContent += `<break time="2s"/>`;
                    }
                });

                ssmlContent += `</speak>`;

                const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${GOOGLE_TTS_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        input: { ssml: ssmlContent },
                        voice: { languageCode: 'en-US' },
                        audioConfig: {
                            audioEncoding: 'MP3',
                            speakingRate: 0.85,
                            pitch: 0.0
                        }
                    })
                });

                const result = await response.json();

                if (result.audioContent) {
                    const audioData = `data:audio/mp3;base64,${result.audioContent}`;
                    generatedAudio[index] = audioData;
                    updateAudioPlayer(index, audioData);
                    
                    if (!generatedAudio.slice(0, index).includes(audioData)) {
                        audioGeneratedCount++;
                    }
                    
                    updateStats();
                    btn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ t·∫°o';
                    btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                    showAlert('success', `T·∫°o audio th√†nh c√¥ng cho ƒëo·∫°n ${index + 1}! (H·ªôi tho·∫°i + C√¢u h·ªèi, kh√¥ng bao g·ªìm ƒë√°p √°n)`);
                } else {
                    throw new Error(result.error?.message || 'Unknown error');
                }

            } catch (error) {
                showAlert('error', `L·ªói khi t·∫°o audio: ${error.message}`);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> L·ªói';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            btn.disabled = false;
        }

        // C·∫≠p nh·∫≠t audio player
        function updateAudioPlayer(index, audioData) {
            const audioPlayer = document.getElementById(`audio-${index}`);
            const downloadBtn = document.getElementById(`download-${index}`);
            
            audioPlayer.src = audioData;
            audioPlayer.style.display = 'block';
            audioPlayer.style.width = '100%';
            audioPlayer.style.marginBottom = '10px';
            downloadBtn.disabled = false;
        }

        // T·∫°o t·∫•t c·∫£ audio
        async function generateAllAudio() {
            if (generatedConversations.length === 0) {
                showAlert('error', 'Vui l√≤ng t·∫£i d·ªØ li·ªáu tr∆∞·ªõc!');
                return;
            }

            const btn = document.getElementById('generateAllBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';

            try {
                await generateAudioForPart3();
                btn.innerHTML = '<i class="fas fa-check"></i> Ho√†n th√†nh';
                btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                document.getElementById('uploadCloudinaryBtn').disabled = false;
            } catch (error) {
                showAlert('error', 'C√≥ l·ªói x·∫£y ra khi t·∫°o audio: ' + error.message);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> C√≥ l·ªói';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            btn.disabled = false;
        }

        // Upload m·ªôt audio l√™n Cloudinary
        async function uploadSingleAudioToCloudinary(index) {
            if (!generatedAudio[index]) {
                showAlert('error', 'Ch∆∞a c√≥ audio cho ƒëo·∫°n n√†y!');
                return null;
            }

            try {
                const audioBlob = base64ToBlob(generatedAudio[index]);
                const filename = `toeic_part3_conversation_${index + 1}_${Date.now()}.mp3`;
                
                const cloudinaryUrl = await uploadAudioToCloudinary(audioBlob, filename);
                cloudinaryAudioUrls[index] = cloudinaryUrl;
                
                return cloudinaryUrl;
            } catch (error) {
                console.error(`Error uploading audio ${index + 1}:`, error);
                throw error;
            }
        }

        // T·∫£i JSON cho m·ªôt ƒëo·∫°n c·ª• th·ªÉ
        async function downloadSingleAudio(index) {
            const downloadBtn = document.getElementById(`download-${index}`);
            
            if (!generatedAudio[index]) {
                showAlert('error', 'Ch∆∞a c√≥ audio cho ƒëo·∫°n n√†y!');
                return;
            }

            // Disable button v√† show loading
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';

            try {
                // N·∫øu ch∆∞a upload l√™n Cloudinary th√¨ upload tr∆∞·ªõc
                if (!cloudinaryAudioUrls[index]) {
                    showAlert('info', `ƒêang upload audio ${index + 1} l√™n Cloudinary...`);
                    await uploadSingleAudioToCloudinary(index);
                    uploadedToCloudinaryCount++;
                    updateStats();
                }

                const conv = generatedConversations[index];
                
                // T·∫°o JSON theo format y√™u c·∫ßu
                const jsonItem = {
                    id: conv.id || (500 + index + 1),
                    level: conv.level || `Level ${Math.floor(index / 10) + 1}`,
                    audio: cloudinaryAudioUrls[index],
                    questions: conv.questions.map(q => ({
                        question: q.question,
                        choices: q.choices,
                        correctAnswer: q.correctAnswer,
                        answerType: q.answerType || "other",
                        explanation: q.explanation || ""
                    }))
                };

                // T·∫°o v√† t·∫£i xu·ªëng file JSON
                const jsonString = JSON.stringify(jsonItem, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `toeic_part3_item_${index + 1}_${Date.now()}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                
                downloadBtn.innerHTML = '<i class="fas fa-check"></i> ƒê√£ t·∫£i JSON';
                downloadBtn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                showAlert('success', `ƒê√£ t·∫£i JSON cho ƒëo·∫°n ${index + 1} v·ªõi audio Cloudinary!`);
                
            } catch (error) {
                showAlert('error', `L·ªói khi x·ª≠ l√Ω ƒëo·∫°n ${index + 1}: ${error.message}`);
                downloadBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> L·ªói';
                downloadBtn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            downloadBtn.disabled = false;
        }

        // T·∫£i xu·ªëng t·∫•t c·∫£ audio
        function downloadAllAudio() {
            const validAudio = generatedAudio.filter(audio => audio !== null);
            
            if (validAudio.length === 0) {
                showAlert('error', 'Ch∆∞a c√≥ audio n√†o ƒë∆∞·ª£c t·∫°o!');
                return;
            }

            validAudio.forEach((audio, i) => {
                if (audio) {
                    setTimeout(() => {
                        const link = document.createElement('a');
                        link.href = audio;
                        link.download = `conversation_${i + 1}.mp3`;
                        link.click();
                    }, i * 500);
                }
            });

            showAlert('success', `ƒêang t·∫£i xu·ªëng ${validAudio.length} file audio...`);
        }

        // Upload audio l√™n Cloudinary
        async function uploadAudioToCloudinary(audioBlob, filename) {
            try {
                const formData = new FormData();
                formData.append('file', audioBlob, filename);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                formData.append('resource_type', 'auto');
                formData.append('folder', 'toeic_part3');

                const response = await fetch(CLOUDINARY_UPLOAD_URL, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.secure_url) {
                    return result.secure_url;
                } else {
                    throw new Error(result.error?.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Cloudinary upload error:', error);
                throw error;
            }
        }

        // Convert base64 to Blob
        function base64ToBlob(base64Data, contentType = 'audio/mp3') {
            const base64 = base64Data.split(',')[1];
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: contentType });
        }

        // Upload t·∫•t c·∫£ audio l√™n Cloudinary
        async function uploadAllAudioToCloudinary() {
            if (audioGeneratedCount === 0) {
                showAlert('error', 'Ch∆∞a c√≥ audio n√†o ƒë∆∞·ª£c t·∫°o!');
                return;
            }

            const btn = document.getElementById('uploadCloudinaryBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang upload...';

            try {
                cloudinaryAudioUrls = [];
                
                for (let i = 0; i < generatedAudio.length; i++) {
                    if (generatedAudio[i]) {
                        updateProgress(10 + (i * 80 / generatedAudio.length), `Upload audio ${i + 1}/${generatedAudio.length} l√™n Cloudinary...`);
                        
                        const audioBlob = base64ToBlob(generatedAudio[i]);
                        const filename = `toeic_part3_conversation_${i + 1}_${Date.now()}.mp3`;
                        
                        const cloudinaryUrl = await uploadAudioToCloudinary(audioBlob, filename);
                        cloudinaryAudioUrls[i] = cloudinaryUrl;
                        
                        console.log(`‚úÖ Uploaded ${i + 1}: ${cloudinaryUrl}`);
                        await new Promise(resolve => setTimeout(resolve, 500)); // Delay ƒë·ªÉ tr√°nh rate limit
                    } else {
                        cloudinaryAudioUrls[i] = null;
                    }
                }

                uploadedToCloudinaryCount = cloudinaryAudioUrls.filter(url => url !== null).length;
                updateStats();
                updateProgress(100, `Ho√†n t·∫•t upload ${uploadedToCloudinaryCount} audio l√™n Cloudinary!`);
                
                btn.innerHTML = '<i class="fas fa-check"></i> Upload ho√†n t·∫•t';
                btn.style.background = 'linear-gradient(45deg, #28a745, #20c997)';
                
                document.getElementById('downloadJsonBtn').disabled = false;
                showAlert('success', `ƒê√£ upload th√†nh c√¥ng ${uploadedToCloudinaryCount} audio l√™n Cloudinary!`);
                
            } catch (error) {
                showAlert('error', 'C√≥ l·ªói khi upload l√™n Cloudinary: ' + error.message);
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> L·ªói';
                btn.style.background = 'linear-gradient(45deg, #dc3545, #e83e8c)';
            }

            btn.disabled = false;
        }

        // T·∫°o v√† t·∫£i xu·ªëng JSON v·ªõi format m·ªõi
        function downloadJsonWithCloudinaryUrls() {
            if (uploadedToCloudinaryCount === 0) {
                showAlert('error', 'Ch∆∞a upload audio l√™n Cloudinary!');
                return;
            }

            const jsonData = [];
            
            generatedConversations.forEach((conv, index) => {
                if (cloudinaryAudioUrls[index]) {
                    const jsonItem = {
                        id: conv.id || (500 + index + 1),
                        level: conv.level || `Level ${Math.floor(index / 10) + 1}`,
                        audio: cloudinaryAudioUrls[index],
                        questions: conv.questions.map(q => ({
                            question: q.question,
                            choices: q.choices,
                            correctAnswer: q.correctAnswer,
                            answerType: q.answerType || "other",
                            explanation: q.explanation || ""
                        }))
                    };
                    
                    jsonData.push(jsonItem);
                }
            });

            // T·∫°o file JSON v√† t·∫£i xu·ªëng
            const jsonString = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `toeic_part3_with_cloudinary_audio_${Date.now()}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            showAlert('success', `ƒê√£ t·∫£i xu·ªëng JSON v·ªõi ${jsonData.length} items c√≥ audio Cloudinary!`);
        }

        // X√≥a t·∫•t c·∫£ audio
        function clearAllAudio() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ audio ƒë√£ t·∫°o?')) {
                generatedAudio = new Array(generatedConversations.length).fill(null);
                cloudinaryAudioUrls = new Array(generatedConversations.length).fill(null);
                audioGeneratedCount = 0;
                uploadedToCloudinaryCount = 0;
                
                // Reset t·∫•t c·∫£ audio players
                for (let i = 0; i < generatedConversations.length; i++) {
                    const audioPlayer = document.getElementById(`audio-${i}`);
                    const downloadBtn = document.getElementById(`download-${i}`);
                    const generateBtn = document.getElementById(`btn-${i}`);
                    
                    if (audioPlayer) {
                        audioPlayer.style.display = 'none';
                        audioPlayer.src = '';
                    }
                    if (downloadBtn) {
                        downloadBtn.disabled = true;
                        downloadBtn.innerHTML = '<i class="fas fa-download"></i> T·∫£i JSON';
                        downloadBtn.style.background = 'linear-gradient(45deg, #6c757d, #495057)';
                    }
                    if (generateBtn) {
                        generateBtn.innerHTML = '<i class="fas fa-play"></i> T·∫°o Audio (H·ªôi tho·∫°i + C√¢u h·ªèi)';
                        generateBtn.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
                        generateBtn.disabled = false;
                    }
                }
                
                updateStats();
                document.getElementById('downloadAllBtn').disabled = true;
                document.getElementById('uploadCloudinaryBtn').disabled = true;
                document.getElementById('downloadJsonBtn').disabled = true;
                
                // Reset n√∫t upload Cloudinary
                const uploadBtn = document.getElementById('uploadCloudinaryBtn');
                uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Batch Upload t·∫•t c·∫£ l√™n Cloudinary';
                uploadBtn.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
                
                showAlert('success', 'ƒê√£ x√≥a t·∫•t c·∫£ audio! H√£y t·∫°o l·∫°i ƒë·ªÉ c√≥ audio m·ªõi (h·ªôi tho·∫°i + c√¢u h·ªèi, kh√¥ng bao g·ªìm ƒë√°p √°n).');
            }
        }

        // X√≥a d·ªØ li·ªáu
        function clearData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu?')) {
                generatedConversations = [];
                generatedAudio = [];
                cloudinaryAudioUrls = [];
                audioGeneratedCount = 0;
                uploadedToCloudinaryCount = 0;
                
                document.getElementById('jsonInput').value = '';
                document.getElementById('jsonFile').value = '';
                document.getElementById('conversationsContainer').style.display = 'none';
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('alertContainer').innerHTML = '';
                
                showAlert('success', 'ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu!');
            }
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            let alertClass, icon;
            
            switch(type) {
                case 'error':
                    alertClass = 'alert-error';
                    icon = 'exclamation-triangle';
                    break;
                case 'success':
                    alertClass = 'alert-success';
                    icon = 'check-circle';
                    break;
                case 'info':
                    alertClass = 'alert-info';
                    icon = 'info-circle';
                    break;
                default:
                    alertClass = 'alert-info';
                    icon = 'info-circle';
            }
            
            const alert = document.createElement('div');
            alert.className = `alert ${alertClass}`;
            alert.innerHTML = `
                <i class="fas fa-${icon}"></i>
                ${message}
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>
</html>
